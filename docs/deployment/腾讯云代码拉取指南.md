# 腾讯云服务器代码拉取指南

## 快速操作步骤

### 1. 登录腾讯云服务器

```bash
cd /Users/liumingwei/01-project/03-personal/06-vps/06-qcloud-vps/
ssh -i sh_qcloud.pem root@43.142.178.200
```

### 2. 进入项目目录

```bash
cd /opt/script-parser/
```

### 3. 使用诊断脚本（推荐）

如果代码拉取有问题，可以使用诊断脚本自动修复：

```bash
# 如果脚本已存在，直接运行
./scripts/fix-git-pull.sh

# 如果脚本不存在，先上传或创建
# 方法1: 从本地复制脚本到服务器
# 方法2: 在服务器上创建脚本（见下方）
```

### 4. 手动诊断步骤

如果脚本不可用，可以手动执行以下步骤：

#### 步骤 1: 检查 Git 状态

```bash
cd /opt/script-parser/

# 检查是否为 Git 仓库
ls -la .git

# 检查远程仓库配置
git remote -v

# 检查当前分支
git branch --show-current

# 检查工作区状态
git status
```

#### 步骤 2: 处理未提交的更改（如果有）

```bash
# 查看未提交的更改
git status

# 选项 A: 暂存更改
git stash save "临时保存更改"

# 选项 B: 提交更改
git add .
git commit -m "chore: 保存本地更改"

# 选项 C: 放弃本地更改（谨慎使用）
git reset --hard HEAD
```

#### 步骤 3: 拉取代码

```bash
# 先获取远程更新
git fetch origin

# 拉取并合并
git pull origin main

# 如果遇到冲突，查看冲突文件
git status

# 解决冲突后
git add .
git commit -m "chore: 解决合并冲突"
```

#### 步骤 4: 如果远程仓库未配置

```bash
# 添加远程仓库（替换为实际的仓库 URL）
git remote add origin <repository-url>

# 或者更新远程仓库 URL
git remote set-url origin <repository-url>

# 验证配置
git remote -v
```

### 5. 常见问题解决

#### 问题 1: 提示 "not a git repository"

**原因**: 目录不是 Git 仓库

**解决**:
```bash
# 如果是新服务器，需要克隆仓库
cd /opt/
rm -rf script-parser  # 如果目录存在但不是 Git 仓库
git clone <repository-url> script-parser
cd script-parser
```

#### 问题 2: 提示 "Permission denied" 或认证失败

**原因**: 没有访问私有仓库的权限

**解决**:
```bash
# 方法 1: 使用 HTTPS + 访问令牌
git remote set-url origin https://<token>@github.com/user/repo.git

# 方法 2: 配置 SSH 密钥
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
cat ~/.ssh/id_rsa.pub
# 将公钥添加到 GitHub/GitLab 等平台

# 方法 3: 使用 SSH URL
git remote set-url origin git@github.com:user/repo.git
```

#### 问题 3: 提示 "fatal: refusing to merge unrelated histories"

**原因**: 本地和远程仓库历史不相关

**解决**:
```bash
git pull origin main --allow-unrelated-histories
```

#### 问题 4: 网络连接问题

**解决**:
```bash
# 测试网络连接
ping github.com
ping gitee.com

# 如果 GitHub 访问困难，可以配置代理或使用镜像
# 或者使用 Gitee 等国内 Git 服务
```

### 6. 拉取成功后重启服务

```bash
# 如果后端代码有更新
docker-compose -f docker-compose.prod.yml restart coprocessor

# 查看服务状态
docker-compose -f docker-compose.prod.yml ps

# 查看日志
docker-compose -f docker-compose.prod.yml logs -f coprocessor

# 健康检查
curl http://localhost:8081/api/health
```

## 一键操作脚本

如果需要在服务器上创建诊断脚本，可以执行：

```bash
cd /opt/script-parser/

cat > scripts/fix-git-pull.sh << 'SCRIPT_END'
#!/bin/bash
# [脚本内容见 scripts/fix-git-pull.sh]
SCRIPT_END

chmod +x scripts/fix-git-pull.sh
./scripts/fix-git-pull.sh
```

## 验证拉取结果

```bash
# 查看最新提交
git log --oneline -5

# 查看文件更改
git diff HEAD~1

# 确认当前分支和远程同步
git status
```

## 注意事项

1. **生产环境谨慎操作**: 在生产环境拉取代码前，建议先备份
2. **检查冲突**: 拉取后检查是否有冲突需要解决
3. **重启服务**: 代码更新后记得重启相关服务
4. **查看日志**: 重启后查看服务日志确认正常运行

## 联系支持

如果遇到无法解决的问题：
1. 查看 Git 错误信息
2. 检查网络连接
3. 验证仓库访问权限
4. 查看服务器日志: `docker-compose -f docker-compose.prod.yml logs`




















