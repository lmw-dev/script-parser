# TOM-499: V3.0 MVP 端到端测试执行报告

**任务ID**: TOM-499  
**执行日期**: 2025-11-12  
**执行人**: 刘明伟  
**环境**: 本地开发环境 (Mac mini)

---

## 📋 测试环境信息

| 项目 | 状态 | 说明 |
|-----|------|------|
| **Web App (Next.js)** | ✅ 运行中 | Port 3000, Turbopack模式 |
| **AI Coprocessor (FastAPI)** | ✅ 运行中 | Port 8000, Reload模式 |
| **热词配置** | ✅ 已配置 | `ALIYUN_TECH_HOTWORD_ID=0fd60c73...` |
| **代码修复** | ✅ 已完成 | `result/page.tsx` 已使用 `resetPartial()` |

---

## 🧪 测试路径清单

### E2E 路径 1: V2.0 回归测试 - "通用叙事"

**目标**: 验证V2.0功能未被破坏

#### 测试步骤

- [ ] 1. 打开浏览器访问 `http://localhost:3000`
- [ ] 2. 在分析模式选择器中选择 **"通用叙事分析 (V2.0)"**
- [ ] 3. 输入一个**非科技类**视频URL（建议使用：抖音美食/旅行视频）
  - 测试URL: `_____________________`
- [ ] 4. 点击"开始分析"按钮
- [ ] 5. 等待处理完成

#### 验证点

**后端验证** (查看终端日志 `apps/coprocessor`):
- [ ] **验证1.1**: ASR服务**未**注入 `vocabulary_id`
  - 查找日志关键词: `"analysis_mode": "general"`
  - 确认**不存在**关键词: `"vocabulary_id":`
  
- [ ] **验证1.2**: LLM路由器调用了正确的Prompt
  - 查找日志关键词: `"Loading prompt: structured_analysis.prompt"`
  - 确认**不存在**关键词: `tech_spec_extraction.prompt`

**前端验证** (浏览器结果页面):
- [ ] **验证1.3**: ResultSection渲染了V2.0卡片
  - ✅ "完整逐字稿"卡片存在
  - ✅ "🚀 钩子 (Hook)"卡片存在
  - ✅ "💡 核心 (Core)"卡片存在
  - ✅ "🎯 行动号召 (CTA)"卡片存在
  - ❌ **不存在**V3.0卡片（产品参数/卖点/价格/评价）

#### 测试结果

- [ ] ✅ 通过
- [ ] ❌ 失败 - 原因: `_____________________`

**截图/日志**:
```
(粘贴关键日志片段)
```

---

### E2E 路径 2: V3.0 核心功能测试 - "科技评测"

**目标**: 验证V3.0核心价值 - 科技术语99%+准确率

#### 测试步骤

- [ ] 1. 刷新浏览器或访问 `http://localhost:3000`
- [ ] 2. 在分析模式选择器中选择 **"科技产品评测 (V3.0)"**
- [ ] 3. 输入一个**科技评测**视频URL（建议使用：MKBHD/爱否科技）
  - 测试URL: `_____________________`
  - 预期包含科技术语: `M4 Max`, `iPhone 15 Pro`, `骁龙8 Gen 3` 等
- [ ] 4. 点击"开始分析"按钮
- [ ] 5. 等待处理完成

#### 验证点

**后端验证** (查看终端日志):
- [ ] **验证2.1**: ASR服务**成功**注入了热词ID
  - 查找日志关键词: `"analysis_mode": "tech"`
  - 查找日志关键词: `"vocabulary_id": "0fd60c73..."`
  
- [ ] **验证2.2**: LLM路由器调用了Tech Prompt
  - 查找日志关键词: `"Loading prompt: tech_spec_extraction.prompt"`

**前端验证** (浏览器结果页面):
- [ ] **验证2.3**: ResultSection渲染了V3.0卡片
  - ❌ "完整逐字稿"卡片**不存在**（科技模式不显示）
  - ✅ "📊 产品参数"卡片存在
  - ✅ "✨ 核心卖点"卡片存在
  - ✅ "💰 价格信息"卡片存在
  - ✅ "👍 优缺点评价"卡片存在

- [ ] **验证2.4**: 热词注入成功验证
  - 在浏览器DevTools中查看API响应 (`/api/parse`)
  - 在返回的 `raw_transcript` 或 `cleaned_transcript` 中搜索科技术语
  - 确认至少包含1个TOM-488定义的术语（如 `M4 Max`, `ProRes`, `Thunderbolt 4`）

- [ ] **验证2.5**: 数据结构正确性
  - 在DevTools中验证 `response.data` 包含 `schema_type: "v3_tech_spec"`
  - 验证 `product_parameters` 是数组且包含 `{parameter, value}` 结构
  - 验证 `selling_points` 包含 `{point, context_snippet}` 结构

#### 测试结果

- [ ] ✅ 通过
- [ ] ❌ 失败 - 原因: `_____________________`

**关键科技术语识别率** (手动统计):
- 视频中提到的科技术语总数: `___` 个
- 正确识别的术语数: `___` 个
- 准确率: `____%`

---

### E2E 路径 3: V3.0 UX测试 - "智能重置"

**目标**: 验证U.S. 2.4 - 批量处理的效率优化

#### 测试步骤

- [ ] 1. **前置条件**: 成功完成 **E2E 路径 2**
- [ ] 2. 在结果页面，点击"再分析一个"按钮
- [ ] 3. 应自动跳转回首页

#### 验证点

- [ ] **验证3.1**: 分析模式被保留
  - ✅ 分析模式选择器**仍然**显示 **"科技产品评测 (V3.0)"**
  - ❌ **不是**默认的 "-- 请选择一个分析模式 --"

- [ ] **验证3.2**: 其他状态被清空
  - ✅ URL输入框为空
  - ✅ 无任何结果显示

- [ ] **验证3.3**: 代码实现确认
  - 打开 `apps/web/src/app/result/page.tsx`
  - 第27行应该是: `resetPartial()` ✅
  - 不应该是: `reset()` ❌

#### 测试结果

- [ ] ✅ 通过
- [ ] ❌ 失败 - 原因: `_____________________`

---

### E2E 路径 4: V3.0 UX测试 - "强制选择"

**目标**: 验证U.S. 2.2 - 防止用户错过P0核心价值

#### 测试步骤

- [ ] 1. **硬刷新**浏览器 (Cmd+Shift+R / Ctrl+Shift+R)
- [ ] 2. 观察分析模式选择器的初始状态
- [ ] 3. **不选择模式**，直接粘贴一个有效URL
- [ ] 4. 观察"开始分析"按钮状态
- [ ] 5. 现在选择任意分析模式
- [ ] 6. 再次观察按钮状态

#### 验证点

- [ ] **验证4.1**: 初始状态
  - ✅ 选择器显示: **"-- 请选择一个分析模式 --"**
  - ✅ "开始分析"按钮为 `disabled` 状态（灰色，无法点击）

- [ ] **验证4.2**: URL输入后，模式未选
  - ✅ URL输入框显示有效URL（✓ 图标）
  - ✅ "开始分析"按钮**仍然** `disabled`

- [ ] **验证4.3**: 选择模式后
  - ✅ "开始分析"按钮变为 `enabled` 状态（可点击）

#### 测试结果

- [ ] ✅ 通过
- [ ] ❌ 失败 - 原因: `_____________________`

---

### E2E 路径 5: V2.1 可靠性测试 - "LLM 故障切换"

**目标**: 验证 V1.0 主备切换逻辑在 V3.0 架构中仍然工作

#### 测试步骤

- [ ] 1. **停止 AI Coprocessor**
  ```bash
  # 在运行 uvicorn 的终端按 Ctrl+C
  ```

- [ ] 2. **修改 `.env` 使主服务失败**
  ```bash
  cd apps/coprocessor
  # 备份原配置
  cp .env .env.backup
  # 修改 DEEPSEEK_API_KEY 为无效值
  echo "DEEPSEEK_API_KEY=invalid_key_for_testing" >> .env
  ```

- [ ] 3. **重启 AI Coprocessor**
  ```bash
  python -m uvicorn app.main:app --reload --port 8000
  ```

- [ ] 4. 执行 **E2E 路径 1**（通用叙事测试）

#### 验证点

**后端日志验证**:
- [ ] **验证5.1**: 主服务尝试失败
  - 查找日志关键词: `"Primary service (DeepSeek) failed"`
  - 或: `"DeepSeek API error"` / `"Unauthorized"` / `"401"`

- [ ] **验证5.2**: 备用服务成功
  - 查找日志关键词: `"Attempting fallback to Kimi"`
  - 或: `"Kimi service succeeded"` / `"200 OK"`

**前端验证**:
- [ ] **验证5.3**: 用户体验无感知
  - ✅ ResultSection**正常**渲染（即使主服务失败）
  - ✅ 显示正确的V2.0卡片（钩子/核心/CTA）
  - ❌ **不显示**任何错误提示

#### 测试结果

- [ ] ✅ 通过
- [ ] ❌ 失败 - 原因: `_____________________`

**恢复操作** (测试完成后):
```bash
# 恢复原始配置
cd apps/coprocessor
mv .env.backup .env
# 重启服务
python -m uvicorn app.main:app --reload --port 8000
```

---

## 📊 测试总结

### 测试通过率

| 测试路径 | 状态 | 说明 |
|---------|------|------|
| E2E 路径 1 (V2.0 回归) | ⬜ 待测试 | |
| E2E 路径 2 (V3.0 核心) | ⬜ 待测试 | |
| E2E 路径 3 (智能重置) | ⬜ 待测试 | |
| E2E 路径 4 (强制选择) | ⬜ 待测试 | |
| E2E 路径 5 (故障切换) | ⬜ 待测试 | |

**总体状态**: ⬜ 未开始 / 🔄 进行中 / ✅ 全部通过 / ⚠️ 部分失败

### 发现的问题

#### 🔴 严重问题 (Blocker)
_暂无_

#### 🟡 次要问题 (Minor)
_暂无_

#### 💡 改进建议
_暂无_

---

## 📝 附加信息

### 推荐测试视频URL

**通用叙事类** (E2E 路径 1):
- 美食: `https://v.douyin.com/xxx` (建议：王刚美食)
- 旅行: `https://v.douyin.com/xxx`

**科技评测类** (E2E 路径 2):
- MKBHD中文: `https://v.douyin.com/xxx`
- 爱否科技: `https://v.douyin.com/xxx`
- 科技美学: `https://v.douyin.com/xxx`

### 日志监控命令

**Web App日志**:
```bash
# 在 apps/web 目录的终端查看
```

**AI Coprocessor日志**:
```bash
# 在 apps/coprocessor 目录的终端查看
# 关键日志过滤:
# - 搜索 "analysis_mode"
# - 搜索 "vocabulary_id"
# - 搜索 "Loading prompt"
```

---

## ✅ 最终验收

- [ ] 所有5个E2E路径均通过
- [ ] 未发现Blocker级别问题
- [ ] 已更新Linear Issue TOM-499状态
- [ ] 已将本报告提交到Git仓库

**签署**:  
执行人: _____________________  
日期: _____________________
