# 🚀 E2E测试快速参考卡\n\n**快速查阅** | **测试执行** | **日志验证** | **问题排查**\n\n---\n\n## ⚡ 30秒快速开始\n\n### 前置检查\n```bash\n# 运行快速检查脚本\nscripts/e2e-quick-check.sh\n\n# 应该全部显示 ✅\n# ✅ Web App (Next.js) 运行中\n# ✅ AI Coprocessor (FastAPI) 运行中\n# ✅ 热词ID已配置\n# ✅ 所有关键代码验证通过\n```\n\n### 打开浏览器\n```\nhttp://localhost:3000\n```\n\n---\n\n## 🧪 5条E2E路径速查表\n\n### 路径 1️⃣: V2.0 回归 (通用叙事)\n\n| 步骤 | 操作 | 验证 |\n|-----|------|------|\n| 1 | 选择 **\"通用叙事分析\"** | 下拉显示2个选项 |\n| 2 | 输入非科技视频URL | 美食/旅行视频 |\n| 3 | 点击分析 | 处理中 (1-3分钟) |\n| 4 | 查看结果 | ✅ 显示: 钩子/核心/CTA |\n| 5 | 后端验证 | ❌ 不含 `vocabulary_id` |\n\n**日志过滤**:\n```bash\n# 在 Coprocessor 终端搜索:\n\"analysis_mode\": \"general\"\n\"Loading prompt: structured_analysis.prompt\"\n❌ 不应出现 \"vocabulary_id\"\n```\n\n---\n\n### 路径 2️⃣: V3.0 核心 (科技评测)\n\n| 步骤 | 操作 | 验证 |\n|-----|------|------|\n| 1 | 选择 **\"科技产品评测\"** | 下拉显示2个选项 |\n| 2 | 输入科技评测视频 | MKBHD/爱否/科技美学 |\n| 3 | 点击分析 | 处理中 (2-4分钟) |\n| 4 | 查看结果 | ✅ 显示: 参数/卖点/价格/评价 |\n| 5 | 术语验证 | 搜索科技术语 (M4/A17等) |\n| 6 | 后端验证 | ✅ 包含 `vocabulary_id` |\n\n**日志过滤**:\n```bash\n# 在 Coprocessor 终端搜索:\n\"analysis_mode\": \"tech\"\n\"vocabulary_id\": \"0fd60c73...\"\n\"Loading prompt: tech_spec_extraction.prompt\"\n```\n\n**DevTools检查** (浏览器 F12):\n1. Network 标签 → 搜索 `/api/parse`\n2. 响应中查看:\n   ```json\n   {\n     \"schema_type\": \"v3_tech_spec\",\n     \"product_parameters\": [...],\n     \"selling_points\": [...]\n   }\n   ```\n\n---\n\n### 路径 3️⃣: 智能重置 (UX)\n\n| 步骤 | 操作 | 验证 |\n|-----|------|------|\n| 1 | 完成路径2 | 看到V3.0结果 |\n| 2 | 点击\"再分析一个\" | 回到首页 |\n| 3 | 检查选择器 | ✅ 仍显示\"科技产品评测\" |\n| 4 | 检查输入框 | ✅ URL已清空 |\n\n**代码验证** (重要!):\n```bash\n# 打开 apps/web/src/app/result/page.tsx\n# 第27行应该是:\nresetPartial()  # ✅ 保留 analysisMode\n\n# 不应该是:\nreset()  # ❌ 会清空 analysisMode\n```\n\n---\n\n### 路径 4️⃣: 强制选择 (UX)\n\n| 步骤 | 操作 | 验证 |\n|-----|------|------|\n| 1 | Cmd+Shift+R 硬刷新 | 清除缓存 |\n| 2 | 观察初始状态 | ✅ 选择器=\" -- 请选择 -- \" |\n| 3 | 粘贴URL | ✅ 按钮仍 `disabled` |\n| 4 | 选择模式 | ✅ 按钮变 `enabled` |\n\n**关键验证**:\n- ✅ URL有效 + 模式未选 = 按钮禁用\n- ✅ URL有效 + 模式已选 = 按钮启用\n- ✅ URL无效 + 模式已选 = 按钮禁用\n\n---\n\n### 路径 5️⃣: LLM故障切换 (可靠性)\n\n| 步骤 | 操作 | 验证 |\n|-----|------|------|\n| 1 | 在Coprocessor终端 Ctrl+C | 停止服务 |\n| 2 | 修改 `.env` | `DEEPSEEK_API_KEY=invalid` |\n| 3 | 重启服务 | `python -m uvicorn...` |\n| 4 | 执行路径1 | 完整测试通用叙事 |\n| 5 | 检查日志 | ✅ 显示主备切换过程 |\n| 6 | 检查结果 | ✅ 正常显示（无错误提示） |\n\n**日志验证**:\n```bash\n# 应该看到:\n\"Primary service (DeepSeek) failed\"\n\"Attempting fallback to Kimi\"\n✅ 最终结果正常显示\n```\n\n**恢复**:\n```bash\ncd apps/coprocessor\nmv .env.backup .env\npython -m uvicorn app.main:app --reload --port 8000\n```\n\n---\n\n## 🔍 常见日志位置\n\n### Web App 日志\n```\n位置: Terminal running \"pnpm dev\" in apps/web\n关键词: \"INFO\", \"ERROR\", \"next dev\"\n搜索: \"analysisMode\", \"POST /api/parse\"\n```\n\n### API Coprocessor 日志\n```\n位置: Terminal running \"uvicorn\" in apps/coprocessor\n关键词: \"INFO\", \"ERROR\", \"Uvicorn running\"\n搜索: \n  - \"analysis_mode\"\n  - \"vocabulary_id\"\n  - \"Loading prompt\"\n  - \"Primary service\"\n  - \"Fallback\"\n```\n\n---\n\n## ❌ 常见问题排查\n\n### 问题 1: 选择器不显示\n```\n症状: Select组件没有出现\n原因: analysisMode 状态未初始化\n排查:\n  1. 检查 apps/web/src/stores/app-store.ts\n  2. 确认 analysisMode: '' 初始值\n  3. 检查 page.tsx 是否传递了 props\n```\n\n### 问题 2: 热词未注入\n```\n症状: 科技术语仍然识别不准 (70% 不是 99%+)\n原因: 热词ID未传递给阿里云API\n排查:\n  1. 检查 .env 中的 ALIYUN_TECH_HOTWORD_ID\n  2. 查看日志是否显示 vocabulary_id\n  3. 确认 ASR Service 的 if analysis_mode == \"tech\"\n```\n\n### 问题 3: 路由器返回错误的结构\n```\n症状: V3.0 模式返回的是 V2.0 结构\n原因: LLMTrackRouter 未正确路由\n排查:\n  1. 检查日志中的 \"Loading prompt\" 信息\n  2. 确认是否调用了正确的 prompt 文件\n  3. 检查 tech_spec_extraction.prompt 是否存在\n```\n\n### 问题 4: 故障切换未工作\n```\n症状: DeepSeek失败时显示错误，未调用Kimi\n原因: 主备切换逻辑未正确实现\n排查:\n  1. 检查 llm_execution_service.py\n  2. 确认 try-except 逻辑\n  3. 验证 Kimi adapter 初始化\n```\n\n---\n\n## 📋 测试检查清单\n\n### 开始前\n- [ ] `pnpm dev` 运行中 (Next.js)\n- [ ] `uvicorn` 运行中 (FastAPI)\n- [ ] `.env` 中有 `ALIYUN_TECH_HOTWORD_ID`\n- [ ] 浏览器访问 `http://localhost:3000` 正常\n\n### 每条路径后\n- [ ] 记录测试URL\n- [ ] 截图关键验证点\n- [ ] 复制相关日志\n- [ ] 标记通过/失败\n\n### 完成后\n- [ ] 5路径全部通过\n- [ ] 生成测试报告\n- [ ] 更新Linear Issue\n- [ ] 提交Git commit\n\n---\n\n## 🔗 快速链接\n\n| 资源 | 链接 |\n|------|------|\n| **完整测试报告** | `docs/testing/TOM-499-E2E-Test-Execution-Report.md` |\n| **项目完成总结** | `docs/V3.0-MVP-Completion-Summary.md` |\n| **快速检查脚本** | `scripts/e2e-quick-check.sh` |\n| **Linear Issue** | https://linear.app/tomorrow-persistence/issue/TOM-499 |\n\n---\n\n## ⏱️ 预计时间\n\n| 路径 | 耗时 | 说明 |\n|-----|------|------|\n| 1 | 5-10分钟 | 通用叙事简单快速 |\n| 2 | 10-15分钟 | 科技评测需要等待ASR |\n| 3 | 2-3分钟 | UX测试快速 |\n| 4 | 3-5分钟 | UX测试快速 |\n| 5 | 15-20分钟 | 需要重启服务 |\n| **总计** | **45-60分钟** | 包括截图和日志收集 |\n\n---\n\n*最后更新: 2025-11-12*  \n*快速参考版 v1.0*\n"}}