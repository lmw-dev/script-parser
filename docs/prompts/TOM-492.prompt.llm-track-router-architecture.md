# âš¡ AI å¯æ‰§è¡Œ Prompt (Executable Prompt)

**ä»»åŠ¡ID:** `TOM-492: Coprocessor: é‡æ„LLMæœåŠ¡ä¸º"èµ›é“è·¯ç”±å™¨"æ¶æ„`  
**åˆ›å»ºæ—¶é—´:** 2025-11-11  
**è§„èŒƒç‰ˆæœ¬:** v2.2 (Agentic & Backend-First)

---

## ğŸ¯ ç›®æ ‡ (Objective)

**Linear Issue**: TOM-492 - Coprocessor: é‡æ„LLMæœåŠ¡ä¸º"èµ›é“è·¯ç”±å™¨"æ¶æ„

**æ ¸å¿ƒæŒ‡ä»¤**: é‡æ„ AI Coprocessor (FastAPI) çš„ LLM æœåŠ¡å±‚ï¼Œå°†å…¶ä» V1.0 çš„"å•ä¸€ä»»åŠ¡"æ¶æ„å‡çº§ä¸º `[[æŠ€æœ¯æ–¹æ¡ˆ - è„šæœ¬å¿«æ‹†-V2.0 (V3.0 MVPç‰ˆ)]]` ä¸­å®šä¹‰çš„"**V2.1 èåˆæ¶æ„**"ï¼ˆ`LLMTrackRouter` + `LLMExecutionService`ï¼‰ï¼Œå®ç°"èµ›é“è·¯ç”±"ï¼ˆå†³ç­–å±‚ï¼‰å’Œ"æ•…éšœåˆ‡æ¢"ï¼ˆæ‰§è¡Œå±‚ï¼‰çš„åˆ†å±‚è®¾è®¡ã€‚**å¿…é¡»éµå¾ª TDD åŸåˆ™ï¼Œæµ‹è¯•å…ˆè¡Œã€‚**

---

## ğŸ“‹ ä¸Šä¸‹æ–‡å‚è€ƒ (Context References)

### ä¸»è¦æ“ä½œæ–‡ä»¶

#### æ–°å»ºæ–‡ä»¶ (å¾…åˆ›å»º)
- `@/apps/coprocessor/app/services/llm_track_router.py` (æ ¸å¿ƒè·¯ç”±å™¨ï¼Œå†³ç­–å±‚)
- `@/apps/coprocessor/app/services/llm_execution_service.py` (æ‰§è¡ŒæœåŠ¡ï¼ŒåŒ…å«ä¸»å¤‡åˆ‡æ¢)
- `@/apps/coprocessor/app/services/test_llm_track_router.py` (è·¯ç”±å™¨å•å…ƒæµ‹è¯•)
- `@/apps/coprocessor/app/services/test_llm_execution_service.py` (æ‰§è¡ŒæœåŠ¡å•å…ƒæµ‹è¯•)

#### å¾…ä¿®æ”¹æ–‡ä»¶ (å·²å­˜åœ¨)
- `@/apps/coprocessor/app/main.py` (API ç«¯ç‚¹å’Œ WorkflowOrchestrator)
- `@/apps/coprocessor/app/services/llm_service.py` (å°†è¢«é‡æ„)

#### è¾“å…¥èµ„äº§
- `@/apps/coprocessor/app/prompts/structured_analysis.prompt` (V2.0 é€šç”¨å™äº‹åˆ†æ prompt)
- `@/apps/coprocessor/app/prompts/tech_spec_extraction.prompt` (V3.0 ç§‘æŠ€è§„æ ¼æå– prompt)

### éœ€è¦éµå¾ªçš„å†…éƒ¨è§„åˆ™

- `@.cursor/rules/001-gen-constitution-principles.mdc` (æ ¸å¿ƒé“å¾‹)
- `@.cursor/rules/005-spec-definition-of-done.mdc` (å®Œæˆæ ‡å‡†)
- `@.cursor/rules/010-gen-coding-standards.mdc` (ç¼–ç æ ‡å‡†)
- `@.cursor/rules/011-gen-naming-conventions.mdc` (å‘½åè§„èŒƒ)
- `@.cursor/rules/021-gen-python-best-practices.mdc` (Python æœ€ä½³å®è·µ)
- `@.cursor/rules/110-spec-api-design.mdc` (API å˜æ›´)
- `@.cursor/rules/120-spec-error-handling.mdc` (æ•…éšœåˆ‡æ¢é”™è¯¯å¤„ç†)
- `@.cursor/rules/130-spec-testing-guide.mdc` (TDD/Mocking è§„èŒƒ)

### å‚è€ƒæ–‡æ¡£

- `@/docs/development/æŠ€æœ¯æ–¹æ¡ˆ - è„šæœ¬å¿«æ‹†-V2.0 (V3.0 MVPç‰ˆ).md` (V2.1 èåˆæ¶æ„è“å›¾)

---

## ğŸ”§ å…·ä½“è¦æ±‚ä¸çº¦æŸ (Requirements & Constraints)

### æŠ€æœ¯æ ˆçº¦æŸ

- **è¯­è¨€**: Python 3.12+ (type hints ä¸¥æ ¼æ¨¡å¼)
- **æ¡†æ¶**: FastAPI, Pydantic
- **æµ‹è¯•æ¡†æ¶**: pytest + unittest.mock
- **å¼‚æ­¥**: æ‰€æœ‰æœåŠ¡æ–¹æ³•å¿…é¡»æ˜¯ `async`

### åŠŸèƒ½è¦æ±‚

#### 1. API å˜æ›´ (Spec 1)

`/api/parse` æ¥å£çš„ Pydantic è¯·æ±‚ä½“æ¨¡å‹**å¿…é¡»**æ–°å¢ä¸€ä¸ªå­—æ®µï¼š

```python
class VideoParseURLRequest(BaseModel):
    url: str
    analysis_mode: str = "general"  # æ–°å¢å­—æ®µï¼Œé»˜è®¤å€¼ä¸º "general"
```

**éªŒè¯è§„åˆ™**:
- `analysis_mode` å¿…é¡»æ˜¯ `"general"` æˆ– `"tech"` ä¹‹ä¸€
- å¦‚æœä¼ å…¥æ— æ•ˆå€¼ï¼Œè¿”å› 422 Unprocessable Entity

#### 2. LLMTrackRouter (Spec 2 - å†³ç­–å±‚)

**èŒè´£**: æ ¹æ® `analysis_mode` å†³ç­–ä½¿ç”¨å“ªä¸ª prompt å’Œå“ªä¸ª schemaã€‚

**æ ¸å¿ƒæ–¹æ³•**:

```python
class LLMTrackRouter:
    """V3.0 èµ›é“è·¯ç”±å™¨ - å†³ç­–å±‚"""
    
    def __init__(self, prompts_dir: Path):
        """åˆå§‹åŒ–è·¯ç”±å™¨
        
        Args:
            prompts_dir: Prompt æ–‡ä»¶æ‰€åœ¨ç›®å½•è·¯å¾„
        """
        self.prompts_dir = prompts_dir
    
    async def get_analysis(
        self, 
        analysis_mode: str, 
        transcript: str, 
        execution_service: "LLMExecutionService"
    ) -> dict:
        """æ ¹æ® analysis_mode è·¯ç”±åˆ°å¯¹åº”çš„åˆ†ææµç¨‹
        
        Args:
            analysis_mode: åˆ†ææ¨¡å¼ ("general" æˆ– "tech")
            transcript: åŸå§‹è½¬å½•æ–‡æœ¬
            execution_service: LLM æ‰§è¡ŒæœåŠ¡å®ä¾‹
            
        Returns:
            åˆ†æç»“æœå­—å…¸
            
        Raises:
            ValueError: å½“ analysis_mode æ— æ•ˆæ—¶
            LLMError: å½“åˆ†æå¤±è´¥æ—¶
        """
        pass
    
    def _load_prompt(self, file_name: str) -> str:
        """ä»æ–‡ä»¶åŠ è½½ prompt æ¨¡æ¿
        
        Args:
            file_name: Prompt æ–‡ä»¶å
            
        Returns:
            Prompt å†…å®¹
            
        Raises:
            FileNotFoundError: å½“æ–‡ä»¶ä¸å­˜åœ¨æ—¶
        """
        pass
```

**è·¯ç”±é€»è¾‘**:

| `analysis_mode` | Prompt æ–‡ä»¶ | æœŸæœ› Schema ç±»å‹ | è¿”å›å­—æ®µ |
|----------------|-------------|------------------|----------|
| `"general"` | `structured_analysis.prompt` | V2_NarrativeOutput | `raw_transcript`, `cleaned_transcript`, `analysis` (hook, core, cta, key_quotes) |
| `"tech"` | `tech_spec_extraction.prompt` | V3_TechSpecOutput | `schema_type`, `product_parameters`, `selling_points`, `pricing_info`, `subjective_evaluation` |

**é‡è¦çº¦æŸ**:
- Router æœ¬èº«**ä¸**ç›´æ¥è°ƒç”¨ LLM APIï¼Œå®ƒåªè´Ÿè´£å†³ç­–
- Router å°†å†³ç­–ç»“æœï¼ˆprompt + å‚æ•°ï¼‰ä¼ é€’ç»™ `LLMExecutionService`
- Router å¿…é¡»å¤„ç† `{{TRANSCRIPT_PLACEHOLDER}}` å ä½ç¬¦æ›¿æ¢ï¼ˆä»…é™ `tech_spec_extraction.prompt`ï¼‰

#### 3. LLMExecutionService (Spec 3 - æ‰§è¡Œå±‚)

**èŒè´£**: å¯é åœ°æ‰§è¡Œ LLM è¯·æ±‚ï¼ŒåŒ…å«ä¸»å¤‡åˆ‡æ¢é€»è¾‘ã€‚

**æ ¸å¿ƒæ–¹æ³•**:

```python
class LLMExecutionService:
    """V1.0 LLM æ‰§è¡ŒæœåŠ¡ - æ‰§è¡Œå±‚ï¼ˆåŒ…å«ä¸»å¤‡åˆ‡æ¢ï¼‰"""
    
    def __init__(self, primary: LLMService, fallback: LLMService):
        """åˆå§‹åŒ–æ‰§è¡ŒæœåŠ¡
        
        Args:
            primary: ä¸» LLM æœåŠ¡ (DeepSeek)
            fallback: å¤‡ç”¨ LLM æœåŠ¡ (Kimi)
        """
        self.primary = primary
        self.fallback = fallback
    
    async def execute_with_failover(self, text: str) -> "AnalysisResult":
        """æ‰§è¡Œ LLM åˆ†æï¼Œæ”¯æŒä¸»å¤‡åˆ‡æ¢
        
        Args:
            text: è¦åˆ†æçš„æ–‡æœ¬ï¼ˆå¯ä»¥æ˜¯ prompt æˆ–åŸå§‹æ–‡æœ¬ï¼‰
            
        Returns:
            AnalysisResult å¯¹è±¡ï¼ˆV2.0 æ ¼å¼ï¼‰
            
        Raises:
            LLMError: å½“æ‰€æœ‰æœåŠ¡éƒ½å¤±è´¥æ—¶
        """
        pass
```

**ä¸»å¤‡åˆ‡æ¢é€»è¾‘** (æ²¿ç”¨ V1.0):

1. å°è¯•ä¸»æœåŠ¡ (DeepSeek)
2. å¦‚æœä¸»æœåŠ¡å¤±è´¥ (`LLMError`)ï¼Œå°è¯•å¤‡ç”¨æœåŠ¡ (Kimi)
3. å¦‚æœæ‰€æœ‰æœåŠ¡éƒ½å¤±è´¥ï¼ŒæŠ›å‡ºåŒ…å«è¯¦ç»†é”™è¯¯ä¿¡æ¯çš„ `LLMError`

**é‡è¦çº¦æŸ**:
- å¿…é¡»å¤ç”¨ç°æœ‰çš„ `DeepSeekAdapter` å’Œ `KimiAdapter`
- å¿…é¡»ä¿ç•™ V1.0 çš„é”™è¯¯å¤„ç†é€»è¾‘
- Execution Service ä¸åº”å…³å¿ƒ"åˆ†ææ¨¡å¼"ï¼Œå®ƒåªè´Ÿè´£å¯é åœ°æ‰§è¡Œè¯·æ±‚

#### 4. WorkflowOrchestrator é›†æˆ (Spec 4)

**å¿…é¡»**ä¿®æ”¹ `main.py` ä¸­çš„ `WorkflowOrchestrator`:

1. **ç§»é™¤ç¡¬ç¼–ç **: åˆ é™¤ `analysis_mode="general"` ç¡¬ç¼–ç 
2. **æ¥æ”¶å‚æ•°**: ä» `/api/parse` è¯·æ±‚ä½“ä¸­è·å– `analysis_mode`
3. **ä¼ é€’ç»™ ASR**: å°† `analysis_mode` ä¼ é€’ç»™ `asr_service.transcribe_from_url()`ï¼ˆTOM-490 å·²å®ç°ï¼‰
4. **è°ƒç”¨ Router**: ä½¿ç”¨æ–°çš„ `LLMTrackRouter.get_analysis()` æ›¿ä»£æ—§çš„ `LLMRouter.analyze()`

**ä¿®æ”¹ä½ç½®**:

```python
# apps/coprocessor/app/main.py

async def process_url_workflow(self, url: str, analysis_mode: str = "general") -> AnalysisData:
    """å¤„ç†URLå·¥ä½œæµ
    
    Args:
        url: è§†é¢‘åˆ†äº«é“¾æ¥
        analysis_mode: åˆ†ææ¨¡å¼ ("general" æˆ– "tech")
    """
    # ... (ç°æœ‰ä»£ç ä¿æŒä¸å˜)
    
    # V3.0 - TOM-492: ä»è¯·æ±‚ä½“åŠ¨æ€è·å– analysis_mode
    transcript_text = await asr_service.transcribe_from_url(
        video_info.download_url, analysis_mode=analysis_mode
    )
    
    # V3.0 - TOM-492: ä½¿ç”¨æ–°çš„èµ›é“è·¯ç”±å™¨
    llm_track_router = self._get_llm_track_router()
    llm_execution_service = self._get_llm_execution_service()
    
    analysis_result = await llm_track_router.get_analysis(
        analysis_mode=analysis_mode,
        transcript=transcript_text,
        execution_service=llm_execution_service
    )
    
    # æ ¹æ® analysis_mode å¤„ç†ä¸åŒçš„è¿”å›ç»“æ„
    if analysis_mode == "general":
        # V2.0 æ ¼å¼
        llm_analysis = {
            "hook": analysis_result.analysis.hook,
            "core": analysis_result.analysis.core,
            "cta": analysis_result.analysis.cta,
        }
        if hasattr(analysis_result.analysis, 'key_quotes') and analysis_result.analysis.key_quotes:
            llm_analysis["key_quotes"] = analysis_result.analysis.key_quotes
    elif analysis_mode == "tech":
        # V3.0 æ ¼å¼ï¼ˆç›´æ¥è¿”å›è·¯ç”±å™¨çš„ç»“æœï¼‰
        llm_analysis = analysis_result
    
    # ... (ç°æœ‰ä»£ç ä¿æŒä¸å˜)
```

### ç±»å‹å®‰å…¨è¦æ±‚ (ğŸ›¡ï¸ Type Safety)

- **æ‰€æœ‰æ–°å¢å‡½æ•°**å¿…é¡»åŒ…å«å®Œæ•´çš„ç±»å‹æ³¨è§£ï¼ˆå‚æ•°å’Œè¿”å›å€¼ï¼‰
- **æ‰€æœ‰ Pydantic æ¨¡å‹**å¿…é¡»å®šä¹‰å®Œæ•´çš„å­—æ®µç±»å‹
- **å¼‚æ­¥å‡½æ•°**å¿…é¡»ä½¿ç”¨ `async def` å’Œ `await`

### é”™è¯¯å¤„ç†è¦æ±‚

- éµå¾ª `@rules/120-spec-error-handling.mdc`
- æ‰€æœ‰æœåŠ¡æ–¹æ³•å¿…é¡»æŠ›å‡ºè¯­ä¹‰åŒ–çš„å¼‚å¸¸ï¼ˆ`LLMError`, `ValueError` ç­‰ï¼‰
- ä¸»å¤‡åˆ‡æ¢å¿…é¡»è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ï¼ˆåŒ…å«ä¸»æœåŠ¡å’Œå¤‡ç”¨æœåŠ¡çš„é”™è¯¯ä¿¡æ¯ï¼‰

---

## ğŸ’» ç¤ºä¾‹ä¸è¾“å‡ºç»“æ„ (Example & Output Structure)

### 4.1 ç”¨æ³•ç¤ºä¾‹ (å°†è¢«è½¬åŒ–ä¸ºæµ‹è¯•ç”¨ä¾‹)

> [!example] **Router ç”¨æ³•ç¤ºä¾‹**
> *AI, ä½ å°†è¦å®ç°çš„ `LLMTrackRouter`ï¼Œæœ€ç»ˆä¼šè¢«è¿™æ ·è°ƒç”¨ã€‚ä½ çš„å®ç°å¿…é¡»èƒ½è®©è¿™ä¸ªç¤ºä¾‹æˆåŠŸè¿è¡Œã€‚*
> 
> ```python
> # åœºæ™¯ 1: General Mode
> router = LLMTrackRouter(prompts_dir=Path("app/prompts"))
> execution_service = LLMExecutionService(primary=DeepSeekAdapter(), fallback=KimiAdapter())
> 
> result = await router.get_analysis(
>     analysis_mode="general",
>     transcript="ä»Šå¤©æˆ‘æ¥è¯„æµ‹ä¸€æ¬¾æ–°çš„æ™ºèƒ½æ‰‹æœº...",
>     execution_service=execution_service
> )
> 
> # é¢„æœŸ: result æ˜¯ä¸€ä¸ª AnalysisResult å¯¹è±¡ï¼ŒåŒ…å« raw_transcript, cleaned_transcript, analysis
> assert "hook" in result.analysis
> 
> # åœºæ™¯ 2: Tech Mode
> result_tech = await router.get_analysis(
>     analysis_mode="tech",
>     transcript="è¿™æ¬¾æ‰‹æœºé‡‡ç”¨äº†éªé¾™8 Gen 3å¤„ç†å™¨ï¼Œå”®ä»·3999å…ƒ...",
>     execution_service=execution_service
> )
> 
> # é¢„æœŸ: result_tech æ˜¯ä¸€ä¸ªå­—å…¸ï¼ŒåŒ…å« product_parameters, selling_points ç­‰
> assert result_tech["schema_type"] == "v3_tech_spec"
> ```

> [!example] **Execution Service ç”¨æ³•ç¤ºä¾‹**
> *AI, ä½ å°†è¦å®ç°çš„ `LLMExecutionService`ï¼Œæœ€ç»ˆä¼šè¢«è¿™æ ·è°ƒç”¨ã€‚*
> 
> ```python
> # ä¸»å¤‡åˆ‡æ¢æµ‹è¯•
> execution_service = LLMExecutionService(
>     primary=DeepSeekAdapter(),
>     fallback=KimiAdapter()
> )
> 
> result = await execution_service.execute_with_failover("åˆ†æè¿™æ®µæ–‡æœ¬...")
> 
> # é¢„æœŸ: å¦‚æœ DeepSeek å¤±è´¥ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ° Kimiï¼Œæœ€ç»ˆè¿”å›æˆåŠŸç»“æœ
> assert result.raw_transcript is not None
> ```

### 4.2 æ ¸å¿ƒå®ç°æ–‡ä»¶ç»“æ„

#### æ–‡ä»¶ 1: `llm_track_router.py`

```python
"""
V3.0 LLM èµ›é“è·¯ç”±å™¨ (Track Router)
èŒè´£: æ ¹æ® analysis_mode å†³ç­–ä½¿ç”¨å“ªä¸ª prompt å’Œ schema
"""

from pathlib import Path
from typing import Dict, Any
from ..services.llm_service import LLMError, AnalysisResult
from .llm_execution_service import LLMExecutionService


class LLMTrackRouter:
    """V3.0 èµ›é“è·¯ç”±å™¨ - å†³ç­–å±‚"""
    
    def __init__(self, prompts_dir: Path):
        self.prompts_dir = prompts_dir
        
        # è·¯ç”±æ˜ å°„è¡¨
        self.route_map = {
            "general": {
                "prompt_file": "structured_analysis.prompt",
                "output_type": "v2_narrative"
            },
            "tech": {
                "prompt_file": "tech_spec_extraction.prompt",
                "output_type": "v3_tech_spec"
            }
        }
    
    async def get_analysis(
        self,
        analysis_mode: str,
        transcript: str,
        execution_service: LLMExecutionService
    ) -> Dict[str, Any]:
        """æ ¹æ® analysis_mode è·¯ç”±åˆ°å¯¹åº”çš„åˆ†ææµç¨‹"""
        # Implementation here
        pass
    
    def _load_prompt(self, file_name: str) -> str:
        """ä»æ–‡ä»¶åŠ è½½ prompt æ¨¡æ¿"""
        # Implementation here
        pass
```

#### æ–‡ä»¶ 2: `llm_execution_service.py`

```python
"""
V1.0 LLM æ‰§è¡ŒæœåŠ¡ (Execution Service)
èŒè´£: å¯é åœ°æ‰§è¡Œ LLM è¯·æ±‚ï¼ŒåŒ…å«ä¸»å¤‡åˆ‡æ¢é€»è¾‘
"""

from typing import Protocol
from ..services.llm_service import LLMService, LLMError, AnalysisResult


class LLMExecutionService:
    """V1.0 LLM æ‰§è¡ŒæœåŠ¡ - æ‰§è¡Œå±‚ï¼ˆåŒ…å«ä¸»å¤‡åˆ‡æ¢ï¼‰"""
    
    def __init__(self, primary: LLMService, fallback: LLMService):
        self.primary = primary
        self.fallback = fallback
    
    async def execute_with_failover(self, text: str) -> AnalysisResult:
        """æ‰§è¡Œ LLM åˆ†æï¼Œæ”¯æŒä¸»å¤‡åˆ‡æ¢"""
        # Implementation here
        pass
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥ (Testing Strategy) **(ç¬¬ä¸€æ­¥æ‰§è¡Œ)**

### AIè§’è‰²ï¼šè½¯ä»¶è´¨é‡ä¿è¯å·¥ç¨‹å¸ˆ (AI Role: Software QA Engineer)

ä½ å°†æ‰®æ¼”ä¸€ä¸ªä¸“ä¸šçš„ã€éµå¾ª"æ™ºèƒ½ä½“æµ‹è¯•"ç†å¿µçš„è½¯ä»¶è´¨é‡ä¿è¯å·¥ç¨‹å¸ˆã€‚ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯ä¸ºå³å°†å¼€å‘çš„åŠŸèƒ½ç”Ÿæˆä¸€å¥—å…¨é¢ã€ä¸¥è°¨çš„æµ‹è¯•ç”¨ä¾‹ã€‚

### æ ¸å¿ƒåŸåˆ™

- **æµ‹è¯•ä¼˜å…ˆçº§**: éµå¾ª"åç«¯ä¼˜å…ˆ"åŸåˆ™ã€‚æœ¬ä»»åŠ¡ä¸ºåç«¯ API æ ¸å¿ƒé€»è¾‘ï¼Œå¿…é¡»ç¼–å†™è¯¦å°½çš„å•å…ƒæµ‹è¯•ã€‚
- **TDD æµç¨‹**: å¿…é¡»å…ˆç¼–å†™å¤±è´¥çš„æµ‹è¯•ï¼Œç„¶åå®ç°åŠŸèƒ½ï¼Œæœ€åç¡®è®¤æ‰€æœ‰æµ‹è¯•é€šè¿‡ã€‚

### æœ¬ä»»åŠ¡ä¸»è¦æµ‹è¯•ç±»å‹: å•å…ƒæµ‹è¯• (Unit Tests)

---

### 5.1 å•å…ƒæµ‹è¯• - LLMTrackRouter

#### ç›®æ ‡: éªŒè¯è·¯ç”±å™¨çš„å†³ç­–é€»è¾‘ï¼ˆä¸æ¶‰åŠçœŸå® LLM API è°ƒç”¨ï¼‰

#### æµ‹è¯•æ–‡ä»¶: `apps/coprocessor/app/services/test_llm_track_router.py`

#### AIæ‰§è¡Œè¦æ±‚:

**ç¬¬ä¸€æ­¥: åˆ›å»ºæµ‹è¯•æ–‡ä»¶å¹¶ç¼–å†™å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹**

- [ ] **åˆ›å»ºæµ‹è¯•æ–‡ä»¶** `test_llm_track_router.py`
- [ ] **ç¼–å†™ä»¥ä¸‹æµ‹è¯•ç”¨ä¾‹** (æ‰€æœ‰æµ‹è¯•å¿…é¡»ä½¿ç”¨ `@pytest.mark.asyncio` è£…é¥°å™¨):

##### Test 1: `test_router_general_mode_loads_correct_prompt`

**ç›®çš„**: æ–­è¨€å½“ `analysis_mode="general"` æ—¶ï¼Œè·¯ç”±å™¨åŠ è½½ `structured_analysis.prompt`

**Mock ç­–ç•¥**:
- Mock `execution_service.execute_with_failover` è¿”å›ä¸€ä¸ªå‡çš„ `AnalysisResult` å¯¹è±¡

**æ–­è¨€**:
- éªŒè¯ `_load_prompt` è¢«è°ƒç”¨æ—¶ä¼ å…¥çš„å‚æ•°æ˜¯ `"structured_analysis.prompt"`
- éªŒè¯æœ€ç»ˆè¿”å›çš„ç»“æœåŒ…å« `raw_transcript`, `cleaned_transcript`, `analysis` å­—æ®µ

##### Test 2: `test_router_tech_mode_loads_correct_prompt`

**ç›®çš„**: æ–­è¨€å½“ `analysis_mode="tech"` æ—¶ï¼Œè·¯ç”±å™¨åŠ è½½ `tech_spec_extraction.prompt`

**Mock ç­–ç•¥**:
- Mock `execution_service.execute_with_failover` è¿”å›ä¸€ä¸ªå‡çš„æŠ€æœ¯è§„æ ¼å­—å…¸

**æ–­è¨€**:
- éªŒè¯ `_load_prompt` è¢«è°ƒç”¨æ—¶ä¼ å…¥çš„å‚æ•°æ˜¯ `"tech_spec_extraction.prompt"`
- éªŒè¯æœ€ç»ˆè¿”å›çš„ç»“æœåŒ…å« `schema_type`, `product_parameters` ç­‰å­—æ®µ

##### Test 3: `test_router_tech_mode_replaces_placeholder`

**ç›®çš„**: æ–­è¨€ Tech Mode çš„ prompt ä¸­çš„ `{{TRANSCRIPT_PLACEHOLDER}}` è¢«æ­£ç¡®æ›¿æ¢

**Mock ç­–ç•¥**:
- Mock `_load_prompt` è¿”å›åŒ…å« `{{TRANSCRIPT_PLACEHOLDER}}` çš„å­—ç¬¦ä¸²
- Mock `execution_service.execute_with_failover` æ•è·ä¼ å…¥çš„æ–‡æœ¬

**æ–­è¨€**:
- éªŒè¯ä¼ é€’ç»™ `execute_with_failover` çš„æ–‡æœ¬ä¸­ï¼Œå ä½ç¬¦å·²è¢«å®é™… transcript æ›¿æ¢

##### Test 4: `test_router_invalid_mode_raises_error`

**ç›®çš„**: æ–­è¨€ä¼ å…¥æ— æ•ˆçš„ `analysis_mode` æ—¶æŠ›å‡º `ValueError`

**è¾“å…¥**: `analysis_mode="invalid_mode"`

**æ–­è¨€**:
- ä½¿ç”¨ `pytest.raises(ValueError)` éªŒè¯æŠ›å‡ºå¼‚å¸¸
- éªŒè¯å¼‚å¸¸æ¶ˆæ¯åŒ…å«æœ‰ç”¨çš„æç¤ºä¿¡æ¯

##### Test 5: `test_router_general_mode_returns_v2_format`

**ç›®çš„**: æ–­è¨€ General Mode è¿”å› V2.0 æ ¼å¼çš„æ•°æ®ç»“æ„

**Mock ç­–ç•¥**:
- Mock `execution_service.execute_with_failover` è¿”å›åŒ…å« `analysis.hook`, `analysis.core`, `analysis.cta` çš„å¯¹è±¡

**æ–­è¨€**:
- éªŒè¯è¿”å›ç»“æœæ˜¯ `AnalysisResult` ç±»å‹
- éªŒè¯ `result.analysis.hook` æ˜¯å­—ç¬¦ä¸²

- [ ] **è¿è¡Œæµ‹è¯•**: `cd /Users/liumingwei/01-project/12-liumw/14-script-parser/apps/coprocessor && pytest app/services/test_llm_track_router.py -v`
- [ ] **ç¡®è®¤æ‰€æœ‰æµ‹è¯•å¤±è´¥** (å› ä¸º `llm_track_router.py` å°šæœªå®ç°)

---

### 5.2 å•å…ƒæµ‹è¯• - LLMExecutionService

#### ç›®æ ‡: éªŒè¯ä¸»å¤‡åˆ‡æ¢é€»è¾‘çš„å¯é æ€§

#### æµ‹è¯•æ–‡ä»¶: `apps/coprocessor/app/services/test_llm_execution_service.py`

#### AIæ‰§è¡Œè¦æ±‚:

**ç¬¬ä¸€æ­¥: åˆ›å»ºæµ‹è¯•æ–‡ä»¶å¹¶ç¼–å†™å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹**

- [ ] **åˆ›å»ºæµ‹è¯•æ–‡ä»¶** `test_llm_execution_service.py`
- [ ] **ç¼–å†™ä»¥ä¸‹æµ‹è¯•ç”¨ä¾‹**:

##### Test 1: `test_execution_service_primary_success`

**ç›®çš„**: æ–­è¨€å½“ä¸»æœåŠ¡ (DeepSeek) æˆåŠŸæ—¶ï¼Œç›´æ¥è¿”å›ç»“æœï¼Œä¸è°ƒç”¨å¤‡ç”¨æœåŠ¡

**Mock ç­–ç•¥**:
- Mock `primary.analyze` è¿”å›æˆåŠŸçš„ `AnalysisResult`
- Mock `fallback.analyze` (ä¸åº”è¢«è°ƒç”¨)

**æ–­è¨€**:
- éªŒè¯ `primary.analyze` è¢«è°ƒç”¨ 1 æ¬¡
- éªŒè¯ `fallback.analyze` è¢«è°ƒç”¨ 0 æ¬¡
- éªŒè¯è¿”å›çš„ç»“æœä¸ `primary` è¿”å›çš„ç»“æœä¸€è‡´

##### Test 2: `test_execution_service_primary_fails_fallback_succeeds`

**ç›®çš„**: æ–­è¨€å½“ä¸»æœåŠ¡å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æœåŠ¡

**Mock ç­–ç•¥**:
- Mock `primary.analyze` æŠ›å‡º `LLMError("DeepSeek timeout")`
- Mock `fallback.analyze` è¿”å›æˆåŠŸçš„ `AnalysisResult`

**æ–­è¨€**:
- éªŒè¯ `primary.analyze` è¢«è°ƒç”¨ 1 æ¬¡
- éªŒè¯ `fallback.analyze` è¢«è°ƒç”¨ 1 æ¬¡
- éªŒè¯æœ€ç»ˆè¿”å›çš„ç»“æœæ˜¯ `fallback` çš„ç»“æœ

##### Test 3: `test_execution_service_all_fail`

**ç›®çš„**: æ–­è¨€å½“æ‰€æœ‰æœåŠ¡éƒ½å¤±è´¥æ—¶ï¼ŒæŠ›å‡ºåŒ…å«è¯¦ç»†é”™è¯¯ä¿¡æ¯çš„ `LLMError`

**Mock ç­–ç•¥**:
- Mock `primary.analyze` æŠ›å‡º `LLMError("DeepSeek API error")`
- Mock `fallback.analyze` æŠ›å‡º `LLMError("Kimi API error")`

**æ–­è¨€**:
- ä½¿ç”¨ `pytest.raises(LLMError)` éªŒè¯æŠ›å‡ºå¼‚å¸¸
- éªŒè¯å¼‚å¸¸æ¶ˆæ¯åŒæ—¶åŒ…å« "DeepSeek API error" å’Œ "Kimi API error"

- [ ] **è¿è¡Œæµ‹è¯•**: `cd /Users/liumingwei/01-project/12-liumw/14-script-parser/apps/coprocessor && pytest app/services/test_llm_execution_service.py -v`
- [ ] **ç¡®è®¤æ‰€æœ‰æµ‹è¯•å¤±è´¥** (å› ä¸º `llm_execution_service.py` å°šæœªå®ç°)

---

## ğŸ”„ å®ç°æ­¥éª¤ (Implementation Steps) **(ç¬¬äºŒæ­¥æ‰§è¡Œ)**

### AIæ‰§è¡Œè¦æ±‚ (å¼ºåˆ¶æ€§)

- [ ] **ç¬¬1æ­¥ (API å˜æ›´)**: ä¿®æ”¹ `main.py` ä¸­çš„ `VideoParseURLRequest` Pydantic æ¨¡å‹ï¼Œæ–°å¢ `analysis_mode: str = "general"` å­—æ®µ
- [ ] **ç¬¬2æ­¥ (åˆ›å»º LLMExecutionService)**: åˆ›å»º `llm_execution_service.py`ï¼Œå®ç°ä¸»å¤‡åˆ‡æ¢é€»è¾‘
  - å¤ç”¨ç°æœ‰çš„ `DeepSeekAdapter` å’Œ `KimiAdapter`
  - å®ç° `execute_with_failover` æ–¹æ³•
  - ç¡®ä¿æ‰€æœ‰ `test_llm_execution_service.py` ä¸­çš„æµ‹è¯•é€šè¿‡
- [ ] **ç¬¬3æ­¥ (åˆ›å»º LLMTrackRouter)**: åˆ›å»º `llm_track_router.py`ï¼Œå®ç°è·¯ç”±å†³ç­–é€»è¾‘
  - å®ç° `get_analysis` æ–¹æ³•
  - å®ç° `_load_prompt` è¾…åŠ©æ–¹æ³•
  - å¤„ç† `{{TRANSCRIPT_PLACEHOLDER}}` å ä½ç¬¦æ›¿æ¢ï¼ˆä»…é™ tech modeï¼‰
  - ç¡®ä¿æ‰€æœ‰ `test_llm_track_router.py` ä¸­çš„æµ‹è¯•é€šè¿‡
- [ ] **ç¬¬4æ­¥ (é›†æˆåˆ° WorkflowOrchestrator)**: ä¿®æ”¹ `main.py` ä¸­çš„ `WorkflowOrchestrator`
  - ç§»é™¤ `analysis_mode="general"` ç¡¬ç¼–ç ï¼ˆ2 å¤„ï¼šURL å’Œ File å·¥ä½œæµï¼‰
  - æ–°å¢ `_get_llm_track_router()` å’Œ `_get_llm_execution_service()` æ–¹æ³•ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼‰
  - åœ¨ `process_url_workflow` å’Œ `process_file_workflow` ä¸­ä½¿ç”¨æ–°çš„è·¯ç”±å™¨
  - æ ¹æ® `analysis_mode` å¤„ç†ä¸åŒçš„è¿”å›ç»“æ„
- [ ] **ç¬¬5æ­¥ (é‡å‘½åæ—§æ–‡ä»¶)**: ä¸ºäº†é¿å…æ··æ·†ï¼Œå°† `llm_service.py` ä¸­çš„ `LLMRouter` ç±»é‡å‘½åä¸º `LLMRouterV1` (æˆ–æ·»åŠ æ³¨é‡Šæ ‡è®°ä¸ºå·²åºŸå¼ƒ)
- [ ] **ç¬¬6æ­¥ (é›†æˆæµ‹è¯•)**: è¿è¡Œå®Œæ•´çš„æµ‹è¯•å¥—ä»¶ï¼Œç¡®ä¿æ‰€æœ‰ç°æœ‰æµ‹è¯•ä»ç„¶é€šè¿‡
  - `cd /Users/liumingwei/01-project/12-liumw/14-script-parser/apps/coprocessor && pytest -v`
- [ ] **ç¬¬7æ­¥ (Lint æ£€æŸ¥)**: ç¡®ä¿ä»£ç ç¬¦åˆ PEP 8 å’Œé¡¹ç›®è§„èŒƒ
  - `cd /Users/liumingwei/01-project/12-liumw/14-script-parser/apps/coprocessor && ruff check . --fix`

---

## ğŸ‰ å®Œæˆæ£€æŸ¥æ¸…å• (Completion Checklist)

### â… . åŠŸèƒ½ä¸è´¨é‡æ£€æŸ¥ (AIå¿…é¡»æ‰§è¡Œ)

- [ ] æ˜¯å¦ä¸¥æ ¼éµå¾ªäº†"æµ‹è¯•å…ˆè¡Œ"çš„æµç¨‹ï¼Ÿ
- [ ] **`test_llm_track_router.py` ä¸­çš„ 5 ä¸ªæµ‹è¯•æ˜¯å¦å…¨éƒ¨é€šè¿‡ï¼Ÿ**
- [ ] **`test_llm_execution_service.py` ä¸­çš„ 3 ä¸ªæµ‹è¯•æ˜¯å¦å…¨éƒ¨é€šè¿‡ï¼Ÿ**
- [ ] **æ‰€æœ‰ç°æœ‰çš„é›†æˆæµ‹è¯•æ˜¯å¦ä»ç„¶é€šè¿‡ï¼Ÿ**
- [ ] æ˜¯å¦éµå¾ªäº†é”™è¯¯å¤„ç†è§„èŒƒ (`@rules/120-spec-error-handling.mdc`)ï¼Ÿ
- [ ] æ˜¯å¦ä¸ºæ‰€æœ‰æ–°å¢çš„å…¬å…±æ–¹æ³•ç¼–å†™äº†æ–‡æ¡£å­—ç¬¦ä¸² (Google Style Docstrings)ï¼Ÿ

### â…¡. æ„å»ºä¸éªŒè¯æ£€æŸ¥ (AIå¿…é¡»æ‰§è¡Œ)

- [ ] **Lintæ£€æŸ¥æ˜¯å¦é€šè¿‡ (`ruff check .`)ï¼Ÿ**
- [ ] **ç±»å‹æ£€æŸ¥æ˜¯å¦é€šè¿‡ (`mypy app/`)ï¼Ÿ**
- [ ] **æ‰€æœ‰ç°æœ‰çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•æ˜¯å¦é€šè¿‡ (`pytest`)ï¼Ÿ**

### â…¢. æµç¨‹ä¸äº¤ä»˜æ£€æŸ¥ (AIåœ¨æœ€åä¸€æ­¥æ‰§è¡Œ)

- [ ] **Git Commit Messageæ˜¯å¦å·²æŒ‰ `@rules/210-wf-git-commit.mdc` è§„èŒƒç”Ÿæˆï¼Ÿ**
- [ ] **æ˜¯å¦å·²å°†æœ¬ Prompt æ–‡æ¡£é“¾æ¥åˆ° Linear Issue TOM-492 çš„è¯„è®ºä¸­ï¼Ÿ**
- [ ] **æ˜¯å¦å·²å°†å®ç°å®Œæˆæƒ…å†µå’ŒæŠ€æœ¯å®šä½æ€»ç»“æ·»åŠ åˆ° Linear Issue TOM-492 çš„è¯„è®ºä¸­ï¼Ÿ**

---

## ğŸ“Œ é‡è¦æé†’ (Critical Reminders)

1. **æµ‹è¯•å¿…é¡»å…ˆè¡Œ**: åœ¨ç¼–å†™ä»»ä½•å®ç°ä»£ç ä¹‹å‰ï¼Œå¿…é¡»å…ˆå®Œæˆæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹çš„ç¼–å†™å¹¶ç¡®è®¤å¤±è´¥ã€‚
2. **ä¸è¦ç ´åç°æœ‰åŠŸèƒ½**: æœ¬æ¬¡é‡æ„ä¸åº”å½±å“ç°æœ‰çš„ V2.0 åŠŸèƒ½ã€‚æ‰€æœ‰ç°æœ‰æµ‹è¯•å¿…é¡»ç»§ç»­é€šè¿‡ã€‚
3. **ä¿æŒæ¥å£ä¸€è‡´æ€§**: å¯¹äº General Modeï¼Œè¿”å›çš„æ•°æ®ç»“æ„å¿…é¡»ä¸ V2.0 å®Œå…¨ä¸€è‡´ï¼Œä»¥ç¡®ä¿å‰ç«¯ä¸å—å½±å“ã€‚
4. **Tech Mode æ˜¯æ–°å¢åŠŸèƒ½**: Tech Mode çš„å®ç°ä¸åº”å½±å“ General Mode çš„è¡Œä¸ºã€‚
5. **ä¸»å¤‡åˆ‡æ¢é€»è¾‘ä¸å˜**: `LLMExecutionService` å¿…é¡»å®Œå…¨å¤ç”¨ V1.0 çš„ä¸»å¤‡åˆ‡æ¢é€»è¾‘ï¼Œä¸åº”å¼•å…¥æ–°çš„é£é™©ã€‚

---

## ğŸ”— ç›¸å…³èµ„æº (Related Resources)

- **Linear Issue**: [TOM-492](https://linear.app/tomorrow-persistence/issue/TOM-492)
- **ä¾èµ–ä»»åŠ¡**:
  - TOM-489 (Web: å®ç°"åˆ†ææ¨¡å¼"é€‰æ‹©å™¨UI) - å·²å®Œæˆ
  - TOM-490 (Coprocessor: é›†æˆé˜¿é‡Œäº‘"è‡ªå®šä¹‰çƒ­è¯"API) - å·²å®Œæˆ
  - TOM-491 (Coprocessor: åˆ›å»º V3.0 ç§‘æŠ€è¯„æµ‹ Prompt) - å·²å®Œæˆ
- **æŠ€æœ¯æ–¹æ¡ˆ**: `@/docs/development/æŠ€æœ¯æ–¹æ¡ˆ - è„šæœ¬å¿«æ‹†-V2.0 (V3.0 MVPç‰ˆ).md`
- **æµ‹è¯•è§„èŒƒ**: `@.cursor/rules/130-spec-testing-guide.mdc`
- **Python æœ€ä½³å®è·µ**: `@.cursor/rules/021-gen-python-best-practices.mdc`

---

**ç”Ÿæˆæ—¶é—´**: 2025-11-11  
**è§„èŒƒç‰ˆæœ¬**: 250-wf-prompt-engineering.mdc v2.2  
**ä»»åŠ¡ä¼˜å…ˆçº§**: P0 (High) - V3.0 MVP å…³é”®è·¯å¾„ä»»åŠ¡

