# TOM-324 AI Instruction Prompt: 实现文件上传功能的前端逻辑

## 🎯 目标 (Objective)

**Linear Issue**: TOM-324 - 实现文件上传功能的前端逻辑
**核心指令**: 通过测试先行(Test-First)的方式，在父组件 page.tsx 中实现文件选择、验证和状态更新的完整逻辑，并将其与受控的 InputSection 组件连接。

## 📋 上下文参考 (Context References)

### 主要操作文件
- 核心文件: @apps/web/src/app/page.tsx (已存在，需修改)
- 测试文件: @apps/web/src/app/__tests__/page.logic.test.ts (待创建)
- 组件文件: @apps/web/src/components/sections/InputSection.tsx (已存在，需修改)

### 需要遵循的内部规则
- @.cursor/rules/130-spec-testing-guide.mdc
- @.cursor/rules/020-gen-typescript-best-practices.mdc
- @.cursor/rules/121-spec-frontend-error-handling.mdc
- @.cursor/rules/140-spec-frontend-state-management.mdc
- @.cursor/rules/010-gen-coding-standards.mdc
- @.cursor/rules/011-gen-naming-conventions.mdc

### 依赖文件
- 验证工具库: @apps/web/src/lib/validation.ts (已存在)
- 类型定义: @apps/web/src/types/script-parser.types.ts (已存在)

## 🔧 具体要求与约束 (Requirements & Constraints)

### 技术栈约束
- **语言**: TypeScript (strict mode)
- **测试框架**: Jest + React Testing Library
- **框架**: Next.js 15 (App Router)
- **状态管理**: React useState (本地状态优先)

### 功能要求
1. **文件处理逻辑**: 在page.tsx中实现handleFileChange函数
2. **状态管理**: 管理selectedFile状态和相关的应用状态
3. **验证集成**: 使用validation.ts中的validateVideoFile函数
4. **错误处理**: 实现完整的错误状态管理和用户反馈
5. **组件连接**: 将文件处理逻辑通过props传递给InputSection组件

### 类型安全要求 (🛡️ Type Safety)
- **类型优先设计**: 使用现有的TypeScript接口，确保类型安全
- **严格模式**: 禁止使用any类型
- **状态类型**: 使用AppState类型管理应用状态

## 📝 期望输出结构 (Expected Output Structure)

### 4.1 测试文件结构 (apps/web/src/app/__tests__/page.logic.test.ts)
```typescript
import { describe, it, expect, jest } from '@jest/globals'
import { validateVideoFile } from '@/lib/validation'
import type { AppState } from '@/types/script-parser.types'

// Mock validation function
jest.mock('@/lib/validation')

describe('page.tsx file handling logic', () => {
  it('should handle valid file selection correctly', () => {
    // Test valid file scenario
  })

  it('should handle invalid file type correctly', () => {
    // Test invalid file type scenario
  })

  it('should handle file size exceeding limit correctly', () => {
    // Test file size limit scenario
  })
})
```

### 4.2 核心实现文件结构 (apps/web/src/app/page.tsx)
```typescript
// 添加selectedFile状态和handleFileChange函数
const [selectedFile, setSelectedFile] = useState<File | null>(null)

const handleFileChange = (file: File | null) => {
  // Implementation to make tests pass
}

// 在InputSection组件中传递props
<InputSection 
  // ... existing props
  selectedFile={selectedFile}
  onFileSelect={handleFileChange}
/>
```

## 🧪 测试策略 (Testing Strategy) **(第一步执行)**

### 单元测试要求 (必须完成)
- **测试覆盖率目标**: 文件处理逻辑 ≥ 90%
- **关键测试场景**: 
  1. 选择有效文件 (video/mp4, 50MB)
  2. 选择无效文件类型 (image/png)
  3. 选择超大文件 (150MB)
  4. 文件选择后的状态更新
  5. 错误处理和用户反馈

### AI执行要求 (强制性)
- [ ] **第1步: 创建测试文件 `apps/web/src/app/__tests__/page.logic.test.ts`**
- [ ] **第2步: 根据"关键测试场景"，编写完整的、但预期会失败的(failing)单元测试**
- [ ] **第3步: 运行测试，确认它们因功能未实现而失败**

## 🔄 实现步骤 (Implementation Steps) **(第二步执行)**

### AI执行要求 (强制性)
- [ ] **第4步: 在page.tsx中实现selectedFile状态和handleFileChange函数**
- [ ] **第5步: 更新InputSection组件的props接口和事件处理**
- [ ] **第6步: 连接父子组件的props传递**
- [ ] **第7步: 反复运行测试，直到所有测试用例全部通过**

## 🎉 完成检查清单 (Completion Checklist)

### Ⅰ. 功能与质量检查 (AI必须执行)
- [ ] 是否严格遵循了"测试先行"的流程？
- [ ] **单元测试是否已编写完成并100%通过？**
- [ ] **文件处理逻辑的测试覆盖率是否达到标准？**
- [ ] 是否遵循了错误处理规范？
- [ ] 是否为所有新增的公共接口编写了文档字符串(TSDoc)？
- [ ] 文件选择UI是否正确反映状态变化？
- [ ] 错误提示是否清晰友好？

### Ⅱ. 构建与验证检查 (AI必须执行)
- [ ] **Lint检查是否通过 (`pnpm --filter web lint`)？**
- [ ] **TypeScript类型检查是否通过 (`tsc --noEmit`)？**
- [ ] **测试是否全部通过 (`pnpm --filter web test`)？**

### Ⅲ. 流程与交付检查 (AI在最后一步执行)
- [ ] **Git Commit Message是否已按`210-wf-git-commit.mdc`规范生成？**
- [ ] **是否已将相关文档链接到Linear Issue的评论中？**

