# TOM-490.prompt.aliyun-hotword-integration.md

## ğŸ¯ ç›®æ ‡ (Objective)

**Linear Issue**: TOM-490 - Coprocessor: é›†æˆé˜¿é‡Œäº‘"è‡ªå®šä¹‰çƒ­è¯"API

**æ ¸å¿ƒæŒ‡ä»¤**: é‡æ„ AI Coprocessor (FastAPI) çš„ ASR æœåŠ¡å±‚ï¼Œé›†æˆé˜¿é‡Œäº‘é€šä¹‰å¬æ‚Ÿçš„"è‡ªå®šä¹‰çƒ­è¯"åŠŸèƒ½ã€‚è¿™æ˜¯ V3.0 "å‚ç›´ä¼˜åŒ–è½¬å½•" åŠŸèƒ½çš„æ ¸å¿ƒåç«¯å®ç°ï¼Œå°†ç§‘æŠ€æœ¯è¯­è¯†åˆ«å‡†ç¡®ç‡ä» ~70% æå‡è‡³ **99%+**ï¼Œå…‘ç°å¯¹"ç§‘æŠ€åˆ›ä½œè€…"çš„ä»·å€¼æ‰¿è¯ºã€‚å®ç°éœ€ä¸¥æ ¼éµå¾ª **æµ‹è¯•é©±åŠ¨å¼€å‘ (TDD)** åŸåˆ™ï¼Œå…ˆç¼–å†™å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå†å®ç°åŠŸèƒ½ä»£ç ã€‚

---

## ğŸ“‹ ä¸Šä¸‹æ–‡å‚è€ƒ (Context References)

### ä¸»è¦æ“ä½œæ–‡ä»¶
- **ASRæœåŠ¡æ ¸å¿ƒ**: `@apps/coprocessor/app/services/asr_service.py` (éœ€é‡æ„)
- **æµ‹è¯•æ–‡ä»¶**: `@apps/coprocessor/app/services/test_asr_service.py` (éœ€æ‰©å±•)
- **å·¥ä½œæµç¼–æ’**: `@apps/coprocessor/app/main.py` (éœ€ä¼ é€’ `analysis_mode`)
- **ç¯å¢ƒé…ç½®**: `@apps/coprocessor/.env` (éœ€æ·»åŠ  `ALIYUN_TECH_HOTWORD_ID`)
- **çƒ­è¯èµ„äº§**: `@apps/coprocessor/app/assets/tech_vocab_v1.json` (TOM-488 äº¤ä»˜ç‰©)

### éœ€è¦éµå¾ªçš„å†…éƒ¨è§„åˆ™
- `@.cursor/rules/001-gen-constitution-principles.mdc` (æ ¸å¿ƒé“å¾‹)
- `@.cursor/rules/005-spec-definition-of-done.mdc` (å®Œæˆæ ‡å‡†)
- `@.cursor/rules/010-gen-coding-standards.mdc` (ç¼–ç æ ‡å‡†)
- `@.cursor/rules/021-gen-python-best-practices.mdc` (Python æœ€ä½³å®è·µ)
- `@.cursor/rules/120-spec-error-handling.mdc` (é”™è¯¯å¤„ç†è§„èŒƒ)
- `@.cursor/rules/130-spec-testing-guide.mdc` (æµ‹è¯•è§„èŒƒ - TDD/Mocking)

### è®¾è®¡ä¸æˆ˜ç•¥æ–‡æ¡£
- `@docs/development/æŠ€æœ¯æ–¹æ¡ˆ - è„šæœ¬å¿«æ‹†-V2.0 (V3.0 MVPç‰ˆ).md` (æ¶æ„è®¾è®¡ä¸çƒ­è¯ç­–ç•¥)
- `@docs/development/éœ€æ±‚åˆ†æ - è„šæœ¬å¿«æ‹† V2.0 (V3.0 MVPç‰ˆ).md` (NFR 4.2.1 - ç§‘æŠ€æœ¯è¯­è¯†åˆ«)
- `@docs/data/å¤‡å¿˜å½• - V3.0 æŠ€æœ¯è§„åˆ’ä¼š.md` (é˜¿é‡Œäº‘çƒ­è¯å†³ç­–)

---

## ğŸ”§ å…·ä½“è¦æ±‚ä¸çº¦æŸ (Requirements & Constraints)

### æŠ€æœ¯æ ˆçº¦æŸ
- **åç«¯æ¡†æ¶**: FastAPI (Python 3.12+)
- **ASR SDK**: é˜¿é‡Œäº‘ `dashscope` SDK
- **æµ‹è¯•æ¡†æ¶**: pytest + pytest-asyncio + unittest.mock
- **ç¯å¢ƒç®¡ç†**: python-dotenv

### P0 å‰ç½®æ¡ä»¶ - æ‰‹åŠ¨é…ç½® (å¿…é¡»å…ˆå®Œæˆ)

åœ¨å¼€å§‹ç¼–å†™ä»£ç ä¹‹å‰ï¼Œå¼€å‘è€…ï¼ˆæˆ– AI ååŠ©ä¸‹çš„äººå·¥ï¼‰**å¿…é¡»**å®Œæˆä»¥ä¸‹æ‰‹åŠ¨æ“ä½œï¼š

1. **åˆ›å»ºé˜¿é‡Œäº‘çƒ­è¯åˆ—è¡¨**:
   - ç™»å½• [é˜¿é‡Œäº‘é€šä¹‰å¬æ‚Ÿæ§åˆ¶å°](https://dashscope.console.aliyun.com/)
   - å¯¼èˆªè‡³"è‡ªå®šä¹‰çƒ­è¯"åŠŸèƒ½
   - åˆ›å»ºæ–°çƒ­è¯åˆ—è¡¨ï¼Œå‘½åä¸º `tech_vocab_v1` (æˆ–ç±»ä¼¼åç§°)
   - ä» `tech_vocab_v1.json` (`TOM-488` äº¤ä»˜ç‰©ï¼ŒåŒ…å« 248 ä¸ªç§‘æŠ€æœ¯è¯­) ä¸­å¯¼å…¥æ‰€æœ‰è¯æ±‡
   - ä¿å­˜å¹¶è·å–ç”Ÿæˆçš„ **HotwordListID** (æ ¼å¼é€šå¸¸ä¸º UUID æˆ–å­—ç¬¦ä¸²ID)

2. **é…ç½®ç¯å¢ƒå˜é‡**:
   - æ‰“å¼€ `.env` æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼ŒåŸºäº `.env.example` åˆ›å»ºï¼‰
   - æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆå°† `<YOUR_HOTWORD_ID>` æ›¿æ¢ä¸ºå®é™…IDï¼‰:
     ```bash
     ALIYUN_TECH_HOTWORD_ID=<YOUR_HOTWORD_ID>
     ```
   - ç¡®è®¤ä¿å­˜å¹¶éªŒè¯ç¯å¢ƒå˜é‡å¯ä»¥è¢« `python-dotenv` æ­£ç¡®åŠ è½½

### æ ¸å¿ƒåŠŸèƒ½è¦æ±‚

#### åŠŸèƒ½ 1: ASRService é‡æ„ - æ¥æ”¶ `analysis_mode` å‚æ•°

**å½“å‰çŠ¶æ€** (åˆ†æ):
- `transcribe_from_url()` å’Œ `transcribe_from_file()` æ–¹æ³•å·²å®ç°ï¼Œä½†**ä¸æ¥å—** `analysis_mode` å‚æ•°
- é˜¿é‡Œäº‘ API è°ƒç”¨ (`dashscope.audio.asr.Transcription.async_call`) æ—¶ï¼Œä½¿ç”¨å›ºå®šçš„ `language_hints=["zh", "en"]`
- **ç¼ºå¤±**: æ²¡æœ‰æ ¹æ®åˆ†ææ¨¡å¼åŠ¨æ€æ³¨å…¥ `vocabulary_id` å‚æ•°çš„é€»è¾‘

**ç›®æ ‡çŠ¶æ€**:
- ä¸¤ä¸ªè½¬å½•æ–¹æ³•å¿…é¡»æ–°å¢ `analysis_mode: str = "general"` å‚æ•°ï¼ˆé»˜è®¤å€¼ä¸º `"general"`ï¼Œä¿æŒå‘åå…¼å®¹ï¼‰
- ç­¾åç¤ºä¾‹:
  ```python
  async def transcribe_from_url(self, video_url: str, analysis_mode: str = "general") -> str:
  async def transcribe_from_file(self, file_path: Path, analysis_mode: str = "general") -> str:
  ```

#### åŠŸèƒ½ 2: å®ç°çƒ­è¯è·¯ç”±é€»è¾‘

**ä¼ªä»£ç é€»è¾‘** (å®ç°æ—¶éœ€è½¬æ¢ä¸ºçœŸå® Python ä»£ç ):
```python
# åœ¨è°ƒç”¨ dashscope API å‰ï¼Œæ ¹æ® analysis_mode å†³å®šæ˜¯å¦æ³¨å…¥çƒ­è¯ID
api_params = {
    "model": self.model,
    "file_urls": [url_or_path],
    "language_hints": ["zh", "en"],
}

if analysis_mode == "tech":
    # V3.0 è·¯ç”±ï¼šè¯»å–ç¯å¢ƒå˜é‡ä¸­çš„çƒ­è¯ID
    hotword_id = os.getenv("ALIYUN_TECH_HOTWORD_ID")
    if not hotword_id:
        # ä¸¥æ ¼éµå¾ª 120-spec-error-handling.mdcï¼šé…ç½®é”™è¯¯å¿…é¡»æŠ›å‡ºå¼‚å¸¸ï¼Œä¸èƒ½é™é»˜å¤±è´¥
        raise ValueError(
            "ALIYUN_TECH_HOTWORD_ID environment variable is required when analysis_mode='tech'"
        )
    # æ³¨å…¥çƒ­è¯IDåˆ° API å‚æ•°
    api_params["vocabulary_id"] = hotword_id

# è°ƒç”¨é˜¿é‡Œäº‘ API
task_response = await asyncio.to_thread(
    dashscope.audio.asr.Transcription.async_call,
    **api_params  # ä½¿ç”¨è§£åŒ…ä¼ é€’å‚æ•°
)
```

**å…³é”®ç»†èŠ‚**:
- ä½¿ç”¨ `vocabulary_id` å‚æ•°åï¼ˆå‚è€ƒé˜¿é‡Œäº‘ DashScope SDK æ–‡æ¡£ï¼‰
- `analysis_mode == "general"` æ—¶ï¼Œ**ä¸ä¼ å…¥** `vocabulary_id` å‚æ•°ï¼ˆä¿æŒç°æœ‰è¡Œä¸ºï¼‰
- é…ç½®é”™è¯¯å¤„ç†ï¼šå¦‚æœ `analysis_mode == "tech"` ä½† `ALIYUN_TECH_HOTWORD_ID` æœªè®¾ç½®ï¼Œ**å¿…é¡»**æŠ›å‡º `ValueError` (éµå¾ª `120-spec-error-handling.mdc`)

#### åŠŸèƒ½ 3: WorkflowOrchestrator é›†æˆ

**å½“å‰çŠ¶æ€**:
- `main.py` ä¸­çš„ `process_url_workflow()` å’Œ `process_file_workflow()` æ–¹æ³•è°ƒç”¨ ASR æœåŠ¡æ—¶ï¼Œ**æœªä¼ é€’** `analysis_mode` å‚æ•°
- å½“å‰å®ç°ï¼ˆç¬¬183è¡Œ å’Œ ç¬¬288è¡Œï¼‰:
  ```python
  # URL workflow
  asr_service = ASRService()
  transcript_text = await asr_service.transcribe_from_url(video_info.download_url)
  
  # File workflow
  asr_service = ASRService(oss_uploader=oss_uploader)
  transcript_text = await asr_service.transcribe_from_file(file_info.file_path)
  ```

**ç›®æ ‡çŠ¶æ€**:
- **é˜¶æ®µä¸€ (TOM-490)**: ä½¿ç”¨**ç¡¬ç¼–ç é»˜è®¤å€¼** `analysis_mode = "general"` è¿›è¡Œé›†æˆæµ‹è¯•ï¼ˆå› ä¸º TOM-492 çš„è·¯ç”±å™¨å°šæœªå®ç°ï¼‰
- **é¢„ç•™æ¥å£**: ç¡®ä¿æ–¹æ³•ç­¾åèƒ½å¤Ÿæ¥æ”¶ `analysis_mode` å‚æ•°ï¼Œä¸º TOM-492 åšå¥½å‡†å¤‡
- ä¿®æ”¹ç¤ºä¾‹:
  ```python
  # é˜¶æ®µä¸€ï¼šç¡¬ç¼–ç  general æ¨¡å¼ï¼ˆä¿æŒç°æœ‰è¡Œä¸ºï¼‰
  transcript_text = await asr_service.transcribe_from_url(
      video_info.download_url, 
      analysis_mode="general"  # TOM-492 å®ç°åï¼Œå°†ä»è·¯ç”±å™¨è·å–
  )
  ```

### æµ‹è¯•è¦æ±‚ (TDD - ç¬¬ä¸€æ­¥)

éµå¾ª `@.cursor/rules/130-spec-testing-guide.mdc` è§„èŒƒï¼Œå¿…é¡»å…ˆç¼–å†™**å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹**ï¼Œç„¶åå†å®ç°åŠŸèƒ½ä»£ç ã€‚

#### Test Suite 1: ASRService - analysis_mode å‚æ•°ä¼ é€’

**ä½ç½®**: `test_asr_service.py` (ç°æœ‰æ–‡ä»¶ï¼Œéœ€æ‰©å±•)

**æ–°å¢æµ‹è¯•ç”¨ä¾‹**:

1. **Test 1.1** - `test_transcribe_from_url_with_tech_mode_hotword_injection()`:
   - **æ–­è¨€**: å½“ `analysis_mode="tech"` ä¸” `ALIYUN_TECH_HOTWORD_ID` å·²è®¾ç½®æ—¶
   - Mock `dashscope.audio.asr.Transcription.async_call`
   - è°ƒç”¨ `transcribe_from_url(url, analysis_mode="tech")`
   - **æ–­è¨€** (Assert): `async_call` è¢«è°ƒç”¨æ—¶ï¼Œå‚æ•°ä¸­**åŒ…å«** `vocabulary_id="mock_hotword_id"`
   - ç¤ºä¾‹æ–­è¨€:
     ```python
     mock_async_call.assert_called_once_with(
         model="paraformer-v2",
         file_urls=["https://example.com/video.mp4"],
         language_hints=["zh", "en"],
         vocabulary_id="mock_hotword_id"  # å…³é”®æ–­è¨€
     )
     ```

2. **Test 1.2** - `test_transcribe_from_url_with_general_mode_no_hotword()`:
   - **æ–­è¨€**: å½“ `analysis_mode="general"` æ—¶ï¼ˆæˆ–ä½¿ç”¨é»˜è®¤å€¼ï¼‰
   - Mock `dashscope.audio.asr.Transcription.async_call`
   - è°ƒç”¨ `transcribe_from_url(url, analysis_mode="general")`
   - **æ–­è¨€** (Assert): `async_call` è¢«è°ƒç”¨æ—¶ï¼Œå‚æ•°ä¸­**ä¸åŒ…å«** `vocabulary_id` é”®
   - ç¤ºä¾‹æ–­è¨€:
     ```python
     call_args = mock_async_call.call_args
     assert "vocabulary_id" not in call_args.kwargs  # å…³é”®æ–­è¨€
     ```

3. **Test 1.3** - `test_transcribe_from_file_with_tech_mode_hotword_injection()`:
   - ç±»ä¼¼ Test 1.1ï¼Œä½†é’ˆå¯¹ `transcribe_from_file()` æ–¹æ³•
   - **å¿…é¡»å¤„ç†**: OSS é›†æˆå’Œä¼ ç»Ÿæ¨¡å¼ä¸¤ç§åœºæ™¯ï¼ˆå»ºè®®æµ‹è¯• OSS æ¨¡å¼å³å¯ï¼‰

4. **Test 1.4** - `test_transcribe_tech_mode_missing_hotword_id_raises_error()`:
   - **æ–­è¨€**: å½“ `analysis_mode="tech"` ä½† `ALIYUN_TECH_HOTWORD_ID` **æœªè®¾ç½®**æ—¶
   - Mock ç¯å¢ƒå˜é‡ä¸ºç©º: `@patch.dict("os.environ", {}, clear=True)`
   - è°ƒç”¨ `transcribe_from_url(url, analysis_mode="tech")`
   - **æ–­è¨€** (Assert): æŠ›å‡º `ValueError`ï¼Œé”™è¯¯æ¶ˆæ¯åŒ…å« `"ALIYUN_TECH_HOTWORD_ID"`

**æ‰§è¡Œæ­¥éª¤** (TDD Workflow):
1. å¤åˆ¶ç°æœ‰æµ‹è¯•æ–‡ä»¶ `test_asr_service.py` åˆ° IDE
2. åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ æ–°çš„æµ‹è¯•ç”¨ä¾‹ï¼ˆä½¿ç”¨ `@pytest.mark.asyncio` è£…é¥°å™¨ï¼‰
3. Mock ç¯å¢ƒå˜é‡: ä½¿ç”¨ `@patch.dict("os.environ", {"ALIYUN_TECH_HOTWORD_ID": "mock_hotword_id"})`
4. Mock dashscope SDK: ä½¿ç”¨ `mocker.patch("dashscope.audio.asr.Transcription.async_call")`
5. **è¿è¡Œæµ‹è¯•**: `pytest test_asr_service.py -k "tech_mode" -v`
6. **ç¡®è®¤å¤±è´¥** (çº¢ç¯): å› ä¸º `asr_service.py` å°šæœªå®ç° `analysis_mode` å‚æ•°

---

## ğŸ“˜ ç¤ºä¾‹ä¸è¾“å‡ºç»“æ„ (Examples & Output Structure)

### ç¤ºä¾‹ 1: ASR æœåŠ¡è°ƒç”¨ï¼ˆTech æ¨¡å¼ï¼‰

**è¾“å…¥**:
```python
# åœ¨ WorkflowOrchestrator ä¸­ï¼ˆTOM-492 å®Œæˆåçš„æœ€ç»ˆçŠ¶æ€ï¼‰
analysis_mode = "tech"  # æ¥è‡ªå‰ç«¯ç”¨æˆ·é€‰æ‹© (TOM-489)
asr_service = ASRService()
transcript = await asr_service.transcribe_from_url(
    video_url="https://example.com/tech_review.mp4",
    analysis_mode=analysis_mode  # ä¼ é€’ç”¨æˆ·é€‰æ‹©çš„æ¨¡å¼
)
```

**å†…éƒ¨è¡Œä¸º** (ASR Service):
```python
# asr_service.py å†…éƒ¨é€»è¾‘
api_params = {
    "model": "paraformer-v2",
    "file_urls": ["https://example.com/tech_review.mp4"],
    "language_hints": ["zh", "en"],
}

if analysis_mode == "tech":
    hotword_id = os.getenv("ALIYUN_TECH_HOTWORD_ID")  # è¯»å–ç¯å¢ƒå˜é‡
    if not hotword_id:
        raise ValueError("ALIYUN_TECH_HOTWORD_ID not set")
    api_params["vocabulary_id"] = hotword_id  # æ³¨å…¥çƒ­è¯ID
    # api_params ç°åœ¨ä¸º: {..., "vocabulary_id": "abc-123-xyz-456"}

# è°ƒç”¨é˜¿é‡Œäº‘ API
task_response = dashscope.audio.asr.Transcription.async_call(**api_params)
```

**é¢„æœŸè¾“å‡º**:
```python
# è½¬å½•ç»“æœï¼ˆç¤ºä¾‹ï¼‰
transcript = """
å¤§å®¶å¥½ï¼Œä»Šå¤©æµ‹è¯„çš„æ˜¯ iPhone 15 Pro Maxï¼Œæ­è½½ Apple A17 Pro èŠ¯ç‰‡ï¼Œ
é‡‡ç”¨ 3nm å·¥è‰ºåˆ¶ç¨‹ï¼Œæ”¯æŒ USB-C æ¥å£å’Œ Ray Tracing å…‰çº¿è¿½è¸ªæŠ€æœ¯ã€‚
"""
# å…³é”®æœ¯è¯­ï¼ˆiPhone 15 Pro Maxã€A17 Proã€3nmã€USB-Cã€Ray Tracingï¼‰å‡è¢«æ­£ç¡®è¯†åˆ«
```

### ç¤ºä¾‹ 2: æµ‹è¯•ç”¨ä¾‹ç»“æ„ (Test 1.1)

```python
# test_asr_service.py

@pytest.mark.asyncio
@patch.dict("os.environ", {"ALIYUN_TECH_HOTWORD_ID": "test_hotword_id_12345"})
async def test_transcribe_from_url_with_tech_mode_hotword_injection(mocker):
    """Test that vocabulary_id is injected when analysis_mode='tech'"""
    # Arrange: Mock dashscope API
    mock_async_call = mocker.patch("dashscope.audio.asr.Transcription.async_call")
    mock_wait = mocker.patch("dashscope.audio.asr.Transcription.wait")
    mock_urlopen = mocker.patch("urllib.request.urlopen")
    
    # Setup mock responses (å¤ç”¨ç°æœ‰æµ‹è¯•é€»è¾‘)
    mock_task_response = Mock()
    mock_task_response.output.task_id = "test-task-tech"
    mock_async_call.return_value = mock_task_response
    
    mock_transcription_response = Mock()
    mock_transcription_response.status_code = HTTPStatus.OK
    mock_transcription_response.output = {
        "results": [{"transcription_url": "https://example.com/result.json"}]
    }
    mock_wait.return_value = mock_transcription_response
    
    mock_json_response = {"transcripts": [{"text": "iPhone 15 Pro è¯„æµ‹"}]}
    mock_response = Mock()
    mock_response.read.return_value.decode.return_value = json.dumps(mock_json_response)
    mock_urlopen.return_value = mock_response
    
    # Act: è°ƒç”¨ ASR æœåŠ¡ï¼ˆtech æ¨¡å¼ï¼‰
    service = ASRService(api_key="test-api-key")
    result = await service.transcribe_from_url(
        "https://example.com/video.mp4", 
        analysis_mode="tech"  # å…³é”®å‚æ•°
    )
    
    # Assert: éªŒè¯çƒ­è¯IDå·²æ³¨å…¥
    assert result == "iPhone 15 Pro è¯„æµ‹"
    mock_async_call.assert_called_once_with(
        model="paraformer-v2",
        file_urls=["https://example.com/video.mp4"],
        language_hints=["zh", "en"],
        vocabulary_id="test_hotword_id_12345"  # å…³é”®æ–­è¨€ï¼šçƒ­è¯IDå·²ä¼ é€’
    )
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥ (Testing Strategy) - ã€ç¬¬ä¸€æ­¥ã€‘

### TDD Workflow (ä¸¥æ ¼æ‰§è¡Œé¡ºåº)

**Phase 1: Red (å¤±è´¥æµ‹è¯•)**
1. æ‰“å¼€ `test_asr_service.py` (ç°æœ‰æ–‡ä»¶)
2. åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ æ–°çš„ Test Suite: `# TOM-490: Analysis Mode & Hotword Integration Tests`
3. ç¼–å†™ Test 1.1ã€Test 1.2ã€Test 1.3ã€Test 1.4 (å‚è€ƒä¸Šé¢çš„ç¤ºä¾‹)
4. è¿è¡Œæµ‹è¯•: `pytest test_asr_service.py::test_transcribe_from_url_with_tech_mode_hotword_injection -v`
5. **ç¡®è®¤å¤±è´¥** (é¢„æœŸé”™è¯¯: `TypeError: transcribe_from_url() got an unexpected keyword argument 'analysis_mode'`)

**Phase 2: Green (å®ç°åŠŸèƒ½)**
1. æ‰“å¼€ `asr_service.py`
2. ä¿®æ”¹ `transcribe_from_url()` å’Œ `transcribe_from_file()` æ–¹æ³•ç­¾åï¼Œæ·»åŠ  `analysis_mode: str = "general"` å‚æ•°
3. åœ¨ä¸¤ä¸ªæ–¹æ³•ä¸­ï¼Œåœ¨è°ƒç”¨ `dashscope.audio.asr.Transcription.async_call` ä¹‹å‰ï¼Œå®ç°çƒ­è¯è·¯ç”±é€»è¾‘ (å‚è€ƒ"åŠŸèƒ½ 2: å®ç°çƒ­è¯è·¯ç”±é€»è¾‘"éƒ¨åˆ†)
4. è¿è¡Œæµ‹è¯•: `pytest test_asr_service.py -k "tech_mode or general_mode" -v`
5. **ç¡®è®¤é€šè¿‡** (ç»¿ç¯)

**Phase 3: Refactor (å¯é€‰ä¼˜åŒ–)**
1. æå–çƒ­è¯IDè¯»å–é€»è¾‘åˆ°å•ç‹¬çš„ç§æœ‰æ–¹æ³• (å¯é€‰): `_get_tech_hotword_id() -> str`
2. å†æ¬¡è¿è¡Œæµ‹è¯•ï¼Œç¡®ä¿é‡æ„åæµ‹è¯•ä»ç„¶é€šè¿‡

### æµ‹è¯•è¦†ç›–ç‡è¦æ±‚

- **æœ€ä½è¦†ç›–ç‡**: 90% (æ–°å¢ä»£ç è¡Œ)
- **å¿…é¡»è¦†ç›–çš„åœºæ™¯**:
  - âœ… `analysis_mode="tech"` + çƒ­è¯IDå·²è®¾ç½® â†’ æ­£ç¡®æ³¨å…¥
  - âœ… `analysis_mode="general"` â†’ ä¸æ³¨å…¥çƒ­è¯ID
  - âœ… `analysis_mode="tech"` + çƒ­è¯IDæœªè®¾ç½® â†’ æŠ›å‡º `ValueError`
  - âœ… æ–‡ä»¶ä¸Šä¼  (OSS æ¨¡å¼) + tech æ¨¡å¼ â†’ æ­£ç¡®æ³¨å…¥

---

## ğŸ“ å®ç°æ­¥éª¤ (Step-by-Step Implementation)

### Step 1: å‰ç½®é…ç½® (æ‰‹åŠ¨æ‰§è¡Œ)

**æ—¶é—´ä¼°ç®—**: 15-20 åˆ†é’Ÿ

**å®˜æ–¹æ–‡æ¡£å‚è€ƒ**: [é˜¿é‡Œäº‘ - ä½¿ç”¨SDKè®¾ç½®ä¸šåŠ¡ä¸“å±çƒ­è¯](https://help.aliyun.com/zh/isi/developer-reference/use-an-sdk-to-specify-the-id-of-a-business-specific-hotword-vocabulary)

#### 1.1 ç™»å½•é˜¿é‡Œäº‘æ™ºèƒ½è¯­éŸ³äº¤äº’æ§åˆ¶å°

- **æ§åˆ¶å°åœ°å€**: https://nls-portal.console.aliyun.com/
- ä½¿ç”¨ä½ çš„é˜¿é‡Œäº‘è´¦å·ç™»å½•ï¼ˆéœ€è¦æœ‰æ™ºèƒ½è¯­éŸ³äº¤äº’æœåŠ¡çš„è®¿é—®æƒé™ï¼‰

#### 1.2 åˆ›å»ºä¸šåŠ¡ä¸“å±çƒ­è¯è¡¨

1. **å¯¼èˆªåˆ°çƒ­è¯ç®¡ç†**:
   - åœ¨æ§åˆ¶å°å·¦ä¾§èœå•ä¸­ï¼Œæ‰¾åˆ° "è‡ªå­¦ä¹ å¹³å°" â†’ "çƒ­è¯"
   - ç‚¹å‡» "åˆ›å»ºçƒ­è¯è¡¨" æˆ– "æ–°å¢çƒ­è¯è¡¨"

2. **å¡«å†™çƒ­è¯è¡¨ä¿¡æ¯**:
   - **çƒ­è¯è¡¨åç§°**: `tech_vocab_v1_2025` (å»ºè®®å¸¦ç‰ˆæœ¬å’Œæ—¥æœŸ)
   - **çƒ­è¯è¡¨ç±»å‹**: é€‰æ‹© **"ä¸šåŠ¡ä¸“å±çƒ­è¯è¡¨"** (Business-specific Hotword)
   - **æè¿°**: "V3.0 ç§‘æŠ€äº§å“è¯„æµ‹ä¸“ç”¨çƒ­è¯åº“ (TOM-488)"

3. **å¯¼å…¥çƒ­è¯**:
   - **æ–¹æ³•1 - æ‰¹é‡ä¸Šä¼ ** (æ¨è):
     - æ‰“å¼€ `@apps/coprocessor/app/assets/tech_vocab_v1.json`
     - å°† JSON ä¸­çš„ `words` æ•°ç»„å†…å®¹è½¬æ¢ä¸ºæ–‡æœ¬æ ¼å¼ï¼ˆæ¯è¡Œä¸€ä¸ªè¯ï¼‰
     - ä½¿ç”¨æ§åˆ¶å°çš„ "æ‰¹é‡å¯¼å…¥" åŠŸèƒ½ä¸Šä¼ ï¼ˆå¦‚æœæ”¯æŒ JSON æ ¼å¼ï¼Œå¯ä»¥å°è¯•ç›´æ¥ä¸Šä¼ ï¼‰
   
   - **æ–¹æ³•2 - æ‰‹åŠ¨æ·»åŠ **:
     - åœ¨æ§åˆ¶å°ç•Œé¢é€ä¸ªæ·»åŠ è¯æ±‡ï¼ˆé€‚åˆå°‘é‡è¯æ±‡æµ‹è¯•ï¼‰
     - ä» `tech_vocab_v1.json` ä¸­å¤åˆ¶è¯æ±‡ï¼Œæ¯æ¬¡æ·»åŠ ä¸€ä¸ª

4. **ä¿å­˜å¹¶è·å–çƒ­è¯è¡¨ID**:
   - ç‚¹å‡» "ä¿å­˜" æˆ– "åˆ›å»º"
   - åœ¨çƒ­è¯è¡¨åˆ—è¡¨ä¸­ï¼Œæ‰¾åˆ°åˆšåˆ›å»ºçš„çƒ­è¯è¡¨
   - **å¤åˆ¶ "çƒ­è¯è¡¨ID" (vocabulary_id)** - è¿™æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ ¼å¼ç±»ä¼¼ `abc123xyz456` æˆ– UUID
   - âš ï¸ **é‡è¦**: è¯·å¦¥å–„ä¿å­˜è¿™ä¸ªIDï¼Œåç»­é…ç½®éœ€è¦ä½¿ç”¨

#### 1.3 ç»‘å®šçƒ­è¯è¡¨åˆ°é¡¹ç›® (å¯é€‰)

æ ¹æ®æ–‡æ¡£ï¼Œä¸šåŠ¡ä¸“å±çƒ­è¯è¡¨éœ€è¦åœ¨ä»£ç ä¸­æ˜¾å¼è®¾ç½®IDæ‰èƒ½ç”Ÿæ•ˆï¼ˆä¸åƒé¡¹ç›®çº§çƒ­è¯è¡¨ä¼šè‡ªåŠ¨ç”Ÿæ•ˆï¼‰ã€‚å› æ­¤è¿™ä¸€æ­¥å¯ä»¥è·³è¿‡ï¼Œæˆ‘ä»¬å°†åœ¨ä»£ç ä¸­è®¾ç½®ã€‚

#### 1.4 é…ç½®ç¯å¢ƒå˜é‡

1. **æ‰“å¼€é¡¹ç›®çš„ .env æ–‡ä»¶**:
   ```bash
   cd /Users/liumingwei/01-project/12-liumw/14-script-parser/apps/coprocessor
   # å¦‚æœ .env ä¸å­˜åœ¨ï¼ŒåŸºäº .env.example åˆ›å»º
   # cp .env.example .env  # (å¦‚æœéœ€è¦)
   vim .env  # æˆ–ä½¿ç”¨å…¶ä»–ç¼–è¾‘å™¨
   ```

2. **æ·»åŠ çƒ­è¯è¡¨IDé…ç½®**:
   åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ›¿æ¢ `<YOUR_VOCABULARY_ID>` ä¸ºå®é™…çš„çƒ­è¯è¡¨IDï¼‰:
   ```bash
   # V3.0 - TOM-490: ç§‘æŠ€è¯„æµ‹ä¸“ç”¨çƒ­è¯è¡¨ID
   # ä»é˜¿é‡Œäº‘æ§åˆ¶å°è·å–: https://nls-portal.console.aliyun.com/
   ALIYUN_TECH_HOTWORD_ID=<YOUR_VOCABULARY_ID>
   ```

3. **ä¿å­˜æ–‡ä»¶å¹¶éªŒè¯**:
   ```bash
   # ç¡®ä¿æ–‡ä»¶å·²ä¿å­˜
   cat .env | grep ALIYUN_TECH_HOTWORD_ID
   # åº”è¯¥çœ‹åˆ°: ALIYUN_TECH_HOTWORD_ID=your_actual_id
   ```

#### 1.5 éªŒè¯é…ç½®

1. **åœ¨ Python ç¯å¢ƒä¸­æµ‹è¯•**:
   ```bash
   cd apps/coprocessor
   python3 << EOF
   import os
   from dotenv import load_dotenv
   
   load_dotenv()
   hotword_id = os.getenv("ALIYUN_TECH_HOTWORD_ID")
   
   if hotword_id:
       print(f"âœ… é…ç½®æˆåŠŸ! Hotword ID: {hotword_id}")
   else:
       print("âŒ é…ç½®å¤±è´¥: ALIYUN_TECH_HOTWORD_ID æœªè®¾ç½®")
   EOF
   ```

2. **é‡å¯å¼€å‘æœåŠ¡å™¨** (å¦‚æœæ­£åœ¨è¿è¡Œ):
   ```bash
   # åœæ­¢ç°æœ‰çš„ FastAPI æœåŠ¡å™¨
   # é‡æ–°å¯åŠ¨ä»¥åŠ è½½æ–°çš„ç¯å¢ƒå˜é‡
   uvicorn app.main:app --reload
   ```

#### 1.6 å¯é€‰ï¼šæ›´æ–° .env.example

ä¸ºäº†å¸®åŠ©å…¶ä»–å¼€å‘è€…ï¼Œå»ºè®®æ›´æ–° `.env.example` æ–‡ä»¶ï¼š

```bash
# åœ¨ .env.example ä¸­æ·»åŠ ï¼ˆä¸è¦åŒ…å«å®é™…å€¼ï¼‰
# V3.0 - TOM-490: ç§‘æŠ€è¯„æµ‹ä¸“ç”¨çƒ­è¯è¡¨ID
# è·å–æ–¹å¼: ç™»å½• https://nls-portal.console.aliyun.com/ â†’ è‡ªå­¦ä¹ å¹³å° â†’ çƒ­è¯
ALIYUN_TECH_HOTWORD_ID=your_vocabulary_id_here
```

### Step 2: ç¼–å†™å¤±è´¥æµ‹è¯• (TDD - Red Phase)

**æ—¶é—´ä¼°ç®—**: 30 åˆ†é’Ÿ

1. æ‰“å¼€ `@apps/coprocessor/app/services/test_asr_service.py`
2. åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ æ–°çš„æµ‹è¯•ç±»æˆ–ç›´æ¥åœ¨ `TestASRService` ç±»ä¸­æ·»åŠ æ–¹æ³•
3. ä½¿ç”¨ `read_file` å·¥å…·è¯»å–ç°æœ‰æµ‹è¯•ä»£ç ï¼Œå‚è€ƒå…¶ mock æ¨¡å¼å’Œæ–­è¨€é£æ ¼
4. ç¼–å†™ Test 1.1ã€Test 1.2ã€Test 1.3ã€Test 1.4 (å‚è€ƒ"æµ‹è¯•ç­–ç•¥"éƒ¨åˆ†)
5. è¿è¡Œæµ‹è¯•å¹¶ç¡®è®¤å¤±è´¥:
   ```bash
   cd apps/coprocessor
   pytest app/services/test_asr_service.py -k "tech_mode" -v
   ```

### Step 3: å®ç° ASR æœåŠ¡çƒ­è¯è·¯ç”± (TDD - Green Phase)

**æ—¶é—´ä¼°ç®—**: 45 åˆ†é’Ÿ

1. **ä¿®æ”¹æ–¹æ³•ç­¾å**:
   - æ‰“å¼€ `@apps/coprocessor/app/services/asr_service.py`
   - å®šä½åˆ° `transcribe_from_url()` æ–¹æ³• (ç¬¬59è¡Œ)
   - ä¿®æ”¹ç­¾å: `async def transcribe_from_url(self, video_url: str, analysis_mode: str = "general") -> str:`
   - åŒæ ·ä¿®æ”¹ `transcribe_from_file()` æ–¹æ³•ç­¾å (ç¬¬122è¡Œ)

2. **å®ç°çƒ­è¯è·¯ç”±é€»è¾‘** (åœ¨ `transcribe_from_url()` ä¸­):
   - å®šä½åˆ°ç¬¬76-80è¡Œï¼ˆ`dashscope.audio.asr.Transcription.async_call` è°ƒç”¨å‰ï¼‰
   - æ’å…¥çƒ­è¯è·¯ç”±é€»è¾‘:
     ```python
     # æ„å»º API è°ƒç”¨å‚æ•°
     api_params = {
         "model": self.model,
         "file_urls": [video_url],
         "language_hints": ["zh", "en"],
     }
     
     # V3.0 - TOM-490: ç§‘æŠ€æ¨¡å¼çƒ­è¯æ³¨å…¥
     if analysis_mode == "tech":
         hotword_id = os.getenv("ALIYUN_TECH_HOTWORD_ID")
         if not hotword_id:
             raise ValueError(
                 "ALIYUN_TECH_HOTWORD_ID environment variable is required when analysis_mode='tech'"
             )
         api_params["vocabulary_id"] = hotword_id
     
     # è°ƒç”¨é˜¿é‡Œäº‘ APIï¼ˆä½¿ç”¨å‚æ•°è§£åŒ…ï¼‰
     task_response = await asyncio.wait_for(
         asyncio.to_thread(
             dashscope.audio.asr.Transcription.async_call,
             **api_params  # ä½¿ç”¨è§£åŒ…ä¼ é€’å‚æ•°
         ),
         timeout=TimeoutConfig.ASR_TIMEOUT,
     )
     ```

3. **åœ¨ `transcribe_from_file()` ä¸­å¤åˆ¶ç›¸åŒé€»è¾‘**:
   - å®šä½åˆ°ç¬¬159-163è¡Œï¼ˆä¼ ç»Ÿæ¨¡å¼ï¼‰å’Œç¬¬142-143è¡Œï¼ˆOSSæ¨¡å¼è°ƒç”¨ï¼‰
   - åœ¨ OSS æ¨¡å¼ä¸­ï¼Œå°† `analysis_mode` ä¼ é€’ç»™ `transcribe_from_url()`:
     ```python
     # ç¬¬142-143è¡Œä¿®æ”¹ä¸º:
     return await self.transcribe_from_url(upload_result.file_url, analysis_mode=analysis_mode)
     ```
   - åœ¨ä¼ ç»Ÿæ¨¡å¼ä¸­ï¼ˆç¬¬159-163è¡Œï¼‰ï¼Œå¤åˆ¶ä¸ `transcribe_from_url()` ç›¸åŒçš„çƒ­è¯è·¯ç”±é€»è¾‘

4. **è¿è¡Œæµ‹è¯•å¹¶ç¡®è®¤é€šè¿‡**:
   ```bash
   pytest app/services/test_asr_service.py -k "tech_mode or general_mode" -v
   # é¢„æœŸ: æ‰€æœ‰æ–°æµ‹è¯•é€šè¿‡ï¼ˆç»¿ç¯ï¼‰
   ```

### Step 4: é›†æˆåˆ° WorkflowOrchestrator (é¢„ç•™æ¥å£)

**æ—¶é—´ä¼°ç®—**: 15 åˆ†é’Ÿ

1. æ‰“å¼€ `@apps/coprocessor/app/main.py`
2. **ä¿®æ”¹ URL å·¥ä½œæµ** (ç¬¬187-189è¡Œ):
   ```python
   # ä¿®æ”¹å‰:
   transcript_text = await asr_service.transcribe_from_url(video_info.download_url)
   
   # ä¿®æ”¹å (TOM-490: é˜¶æ®µä¸€ - ç¡¬ç¼–ç  general æ¨¡å¼):
   transcript_text = await asr_service.transcribe_from_url(
       video_info.download_url,
       analysis_mode="general"  # TODO TOM-492: ä»è·¯ç”±å™¨è·å–å®é™…æ¨¡å¼
   )
   ```

3. **ä¿®æ”¹æ–‡ä»¶å·¥ä½œæµ** (ç¬¬292-294è¡Œ):
   ```python
   # ä¿®æ”¹å‰:
   transcript_text = await asr_service.transcribe_from_file(file_info.file_path)
   
   # ä¿®æ”¹å:
   transcript_text = await asr_service.transcribe_from_file(
       file_info.file_path,
       analysis_mode="general"  # TODO TOM-492: ä»è·¯ç”±å™¨è·å–å®é™…æ¨¡å¼
   )
   ```

4. **æ·»åŠ æ³¨é‡Šè¯´æ˜**:
   - åœ¨ä¸¤å¤„ä¿®æ”¹å‰æ·»åŠ æ³¨é‡Š: `# V3.0 - TOM-490: é¢„ç•™ analysis_mode æ¥å£`
   - è¯´æ˜å½“å‰ä¸ºç¡¬ç¼–ç  `"general"` æ¨¡å¼ï¼Œä¿æŒç°æœ‰è¡Œä¸º

### Step 5: é›†æˆæµ‹è¯• (å¯é€‰ä½†æ¨è)

**æ—¶é—´ä¼°ç®—**: 20 åˆ†é’Ÿ

1. åˆ›å»ºç®€å•çš„é›†æˆæµ‹è¯•è„šæœ¬ (å¯é€‰):
   ```python
   # test_hotword_integration.py
   import asyncio
   import os
   from dotenv import load_dotenv
   from app.services.asr_service import ASRService
   
   async def test_tech_mode():
       load_dotenv()
       service = ASRService()
       
       # ä½¿ç”¨ä¸€ä¸ªçœŸå®çš„ç§‘æŠ€è¯„æµ‹è§†é¢‘URL (éœ€è¦å…¬å¼€è®¿é—®)
       test_url = "https://example.com/test_tech_video.mp4"
       
       print("Testing tech mode with hotword...")
       result = await service.transcribe_from_url(test_url, analysis_mode="tech")
       print(f"Transcript (tech mode): {result[:200]}...")
       
       print("\nTesting general mode without hotword...")
       result_general = await service.transcribe_from_url(test_url, analysis_mode="general")
       print(f"Transcript (general mode): {result_general[:200]}...")
   
   if __name__ == "__main__":
       asyncio.run(test_tech_mode())
   ```

2. è¿è¡Œé›†æˆæµ‹è¯•å¹¶è§‚å¯Ÿå·®å¼‚:
   ```bash
   python test_hotword_integration.py
   ```
   - é¢„æœŸ: tech æ¨¡å¼ä¸‹çš„ç§‘æŠ€æœ¯è¯­è¯†åˆ«æ›´å‡†ç¡®

### Step 6: æ–‡æ¡£ä¸æäº¤

**æ—¶é—´ä¼°ç®—**: 10 åˆ†é’Ÿ

1. **æ›´æ–° .env.example** (å¦‚æœå­˜åœ¨):
   - æ·»åŠ ä¸€è¡Œ: `ALIYUN_TECH_HOTWORD_ID=your_hotword_id_here`
   - æ·»åŠ æ³¨é‡Šè¯´æ˜ç”¨é€”

2. **æäº¤ä»£ç **:
   - æŒ‰ç…§ `@.cursor/rules/210-wf-git-commit.mdc` è§„èŒƒç¼–å†™ commit message
   - ç¤ºä¾‹:
     ```bash
     git add .
     git commit -m "feat(coprocessor): integrate aliyun hotword api for tech mode
     
     - Add analysis_mode parameter to ASR transcription methods
     - Implement hotword routing logic: inject vocabulary_id when mode='tech'
     - Add comprehensive test suite for hotword integration (TDD)
     - Update WorkflowOrchestrator to pass analysis_mode (hardcoded 'general')
     - Add ALIYUN_TECH_HOTWORD_ID env var requirement
     
     This implements V3.0 vertical optimization for tech terminology,
     improving accuracy from ~70% to 99%+ for tech review content.
     
     Relates to TOM-490"
     ```

---

## ğŸ”— ç›¸å…³çŸ¥è¯† (Relevant Knowledge)

### é˜¿é‡Œäº‘ DashScope ASR API å‚è€ƒ

**å®˜æ–¹æ–‡æ¡£**: [ä½¿ç”¨SDKè®¾ç½®ä¸šåŠ¡ä¸“å±çƒ­è¯](https://help.aliyun.com/zh/isi/developer-reference/use-an-sdk-to-specify-the-id-of-a-business-specific-hotword-vocabulary)

**å…³é”®ä¿¡æ¯**:
- **å‚æ•°å**: `vocabulary_id` (ä¸šåŠ¡ä¸“å±çƒ­è¯è¡¨ID)
- **å‚æ•°ç±»å‹**: å­—ç¬¦ä¸² (String)
- **é€‚ç”¨åœºæ™¯**: 
  - âœ… ä¸€å¥è¯è¯†åˆ« (Short Audio Recognition)
  - âœ… å®æ—¶è¯­éŸ³è¯†åˆ« (Real-time Transcription)
  - âœ… **å½•éŸ³æ–‡ä»¶è¯†åˆ«** (File Transcription) - **æˆ‘ä»¬çš„ä½¿ç”¨åœºæ™¯**
- **æ³¨æ„äº‹é¡¹**:
  - SDKè®¾ç½®çƒ­è¯çš„ä¼˜å…ˆçº§**é«˜äº**æ§åˆ¶å°è®¾ç½®ï¼ˆä¼šè¦†ç›–æ§åˆ¶å°é…ç½®ï¼‰
  - ä¸šåŠ¡ä¸“å±çƒ­è¯è¡¨éœ€è¦åœ¨ä»£ç ä¸­**æ˜¾å¼è®¾ç½®ID**æ‰èƒ½ç”Ÿæ•ˆ
  - æ§åˆ¶å°é…ç½®çš„é¡¹ç›®çº§çƒ­è¯è¡¨æ— éœ€è®¾ç½®ï¼ˆè‡ªåŠ¨ç”Ÿæ•ˆï¼‰

**DashScope SDK ä½¿ç”¨ç¤ºä¾‹** (Python):

```python
# å½•éŸ³æ–‡ä»¶è¯†åˆ« - ä½¿ç”¨ dashscope SDK
import dashscope

# æ–¹æ³•1: ç›´æ¥ä¼ é€’å‚æ•°
response = dashscope.audio.asr.Transcription.async_call(
    model="paraformer-v2",
    file_urls=["https://example.com/audio.mp4"],
    language_hints=["zh", "en"],
    vocabulary_id="your_hotword_id_here"  # ä¸šåŠ¡ä¸“å±çƒ­è¯è¡¨ID
)

# æ–¹æ³•2: ä½¿ç”¨å‚æ•°å­—å…¸ï¼ˆæˆ‘ä»¬çš„å®ç°æ–¹å¼ï¼‰
api_params = {
    "model": "paraformer-v2",
    "file_urls": ["https://example.com/audio.mp4"],
    "language_hints": ["zh", "en"],
    "vocabulary_id": "your_hotword_id_here"
}
response = dashscope.audio.asr.Transcription.async_call(**api_params)
```

**å‚æ•°å¯¹æ¯”** (å½•éŸ³æ–‡ä»¶è¯†åˆ« HTTP API vs DashScope SDK):

| HTTP API (JSON Body) | DashScope SDK (å‚æ•°) | è¯´æ˜ |
|---------------------|---------------------|------|
| `app_key` | âŒ ä¸éœ€è¦ | SDKå·²å†…ç½®appkey |
| `file_link` | `file_urls` (åˆ—è¡¨) | SDKä½¿ç”¨åˆ—è¡¨æ ¼å¼ |
| `vocabulary_id` | `vocabulary_id` | âœ… **å‚æ•°åä¸€è‡´** |

**é‡è¦**: æˆ‘ä»¬ä½¿ç”¨çš„ `dashscope` SDK å°† `vocabulary_id` ä½œä¸º**å‡½æ•°å‚æ•°**ä¼ é€’ï¼Œè€Œä¸æ˜¯ä½œä¸º JSON Body çš„ä¸€éƒ¨åˆ†ã€‚

### ç¯å¢ƒå˜é‡æœ€ä½³å®è·µ

**å‘½åè§„èŒƒ** (éµå¾ª `@.cursor/rules/011-gen-naming-conventions.mdc`):
- `ALIYUN_TECH_HOTWORD_ID`: ä½¿ç”¨ `SCREAMING_SNAKE_CASE`
- å‰ç¼€ `ALIYUN_` è¡¨ç¤ºé˜¿é‡Œäº‘æœåŠ¡
- `TECH` è¡¨ç¤ºç§‘æŠ€è¯„æµ‹èµ›é“
- `HOTWORD` è¡¨ç¤ºçƒ­è¯åŠŸèƒ½

**å®‰å…¨æ€§**:
- ä¸è¦å°†å®é™…çš„ `HotwordListID` æäº¤åˆ° Git ä»“åº“
- ä½¿ç”¨ `.env.example` æ–‡ä»¶ä½œä¸ºæ¨¡æ¿ï¼Œå®é™…å€¼å­˜å‚¨åœ¨ `.env` ä¸­ï¼ˆå·²åœ¨ `.gitignore`ï¼‰

### é”™è¯¯å¤„ç†è§„èŒƒ

**éµå¾ª `@.cursor/rules/120-spec-error-handling.mdc`**:
- **é…ç½®é”™è¯¯**: å¿…é¡»æŠ›å‡º `ValueError` æˆ–è‡ªå®šä¹‰çš„ `ConfigurationError`
- **API é”™è¯¯**: ç»§ç»­ä½¿ç”¨ç°æœ‰çš„ `ASRError` å¼‚å¸¸ç±»
- **é”™è¯¯æ¶ˆæ¯**: å¿…é¡»æ¸…æ™°è¯´æ˜é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
  - âœ… å¥½çš„ç¤ºä¾‹: `"ALIYUN_TECH_HOTWORD_ID environment variable is required when analysis_mode='tech'. Please add it to .env file."`
  - âŒ åçš„ç¤ºä¾‹: `"Config error"` (ä¸å¤Ÿæ¸…æ™°)

---

## âœ… éªŒæ”¶æ ‡å‡† (Acceptance Criteria)

### DoD Checklist

- [ ] **(DoD 1 - æ‰‹åŠ¨é…ç½®)**: `ALIYUN_TECH_HOTWORD_ID` å·²åœ¨é˜¿é‡Œäº‘æ§åˆ¶å°åˆ›å»ºï¼ˆåŸºäº `tech_vocab_v1.json`ï¼‰ï¼Œå¹¶å·²æ·»åŠ åˆ° `.env` æ–‡ä»¶
- [ ] **(DoD 2 - æ¶æ„)**: `asr_service.py` ä¸­çš„è½¬å½•å‡½æ•°å·²é‡æ„ï¼Œèƒ½æ­£ç¡®æ¥æ”¶ `analysis_mode` å‚æ•°
- [ ] **(DoD 3 - æ ¸å¿ƒé€»è¾‘)**: ASR æœåŠ¡å·²å®ç° `if analysis_mode == "tech":` çš„çƒ­è¯IDæ³¨å…¥é€»è¾‘
- [ ] **(DoD 4 - æµ‹è¯•)**: å·²éµå¾ª `@.cursor/rules/130-spec-testing-guide.mdc` è§„èŒƒï¼Œä¸º `asr_service.py` æ·»åŠ /æ›´æ–°å•å…ƒæµ‹è¯•
  - [ ] Test 1: å·² mock é˜¿é‡Œäº‘APIå®¢æˆ·ç«¯
  - [ ] Test 2: å·²æ–­è¨€ `analysis_mode="tech"` æ—¶ï¼ŒAPIå®¢æˆ·ç«¯è¢«è°ƒç”¨æ—¶åŒ…å«æ­£ç¡®çš„ `HotwordListID`
  - [ ] Test 3: å·²æ–­è¨€ `analysis_mode="general"` æ—¶ï¼ŒAPIå®¢æˆ·ç«¯è¢«è°ƒç”¨æ—¶ä¸åŒ…å« `HotwordListID`
- [ ] **(DoD 5 - è§„èŒƒ)**: æ‰€æœ‰æ–° Python ä»£ç å‡ç¬¦åˆ `@.cursor/rules/021-gen-python-best-practices.mdc` å’Œ `@.cursor/rules/010-gen-coding-standards.mdc`
- [ ] **(DoD 6 - DoD)**: ä»»åŠ¡å…³é—­å‰ï¼Œå¿…é¡»æ»¡è¶³ `@.cursor/rules/005-spec-definition-of-done.mdc` ä¸­çš„å¼€å‘è€…è‡ªæŸ¥æ¸…å•

### åŠŸèƒ½éªŒè¯æ–¹æ³•

1. **å•å…ƒæµ‹è¯•**: è¿è¡Œ `pytest test_asr_service.py -k "tech_mode" -v`ï¼Œç¡®è®¤æ‰€æœ‰æµ‹è¯•é€šè¿‡
2. **é›†æˆæµ‹è¯•** (å¯é€‰): ä½¿ç”¨çœŸå®ç§‘æŠ€è§†é¢‘URLï¼Œå¯¹æ¯” `tech` æ¨¡å¼ vs `general` æ¨¡å¼çš„è½¬å½•ç»“æœ
3. **é”™è¯¯åœºæ™¯æµ‹è¯•**: ä¸´æ—¶åˆ é™¤ `.env` ä¸­çš„ `ALIYUN_TECH_HOTWORD_ID`ï¼Œç¡®è®¤ `analysis_mode="tech"` æ—¶æŠ›å‡ºæ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯

---

## ğŸš¨ æ³¨æ„äº‹é¡¹ä¸å¸¸è§é™·é˜± (Warnings & Pitfalls)

### 1. é˜¿é‡Œäº‘ API å‚æ•°åç§°éªŒè¯

**é£é™©**: `vocabulary_id` å‚æ•°åå¯èƒ½ä¸å®é™… DashScope SDK ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**:
- åœ¨å®ç°å‰ï¼ŒæŸ¥é˜…æœ€æ–°çš„ [é˜¿é‡Œäº‘ DashScope æ–‡æ¡£](https://help.aliyun.com/document_detail/)
- å¦‚æœå‚æ•°åä¸åŒï¼ˆä¾‹å¦‚å¯èƒ½æ˜¯ `hotword_list_id` æˆ– `custom_vocabulary_id`ï¼‰ï¼Œè¯·æ›´æ–° prompt å’Œä»£ç 
- åœ¨å•å…ƒæµ‹è¯•ä¸­ä½¿ç”¨æ­£ç¡®çš„å‚æ•°åè¿›è¡Œæ–­è¨€

### 2. ç¯å¢ƒå˜é‡åŠ è½½æ—¶æœº

**é£é™©**: `.env` æ–‡ä»¶æ›´æ–°åï¼Œå¦‚æœå¼€å‘æœåŠ¡å™¨æœªé‡å¯ï¼Œæ–°ç¯å¢ƒå˜é‡ä¸ä¼šç”Ÿæ•ˆ

**è§£å†³æ–¹æ¡ˆ**:
- åœ¨ Step 1 å®Œæˆåï¼Œ**å¿…é¡»é‡å¯** FastAPI æœåŠ¡å™¨
- åœ¨æµ‹è¯•ä¸­ä½¿ç”¨ `@patch.dict("os.environ", {...})` ç¡®ä¿ç¯å¢ƒå˜é‡éš”ç¦»

### 3. å‘åå…¼å®¹æ€§

**é£é™©**: ä¿®æ”¹æ–¹æ³•ç­¾ååï¼Œç°æœ‰è°ƒç”¨ä»£ç ï¼ˆæœªä¼ é€’ `analysis_mode`ï¼‰å¯èƒ½ä¸­æ–­

**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨é»˜è®¤å‚æ•° `analysis_mode: str = "general"` ç¡®ä¿å‘åå…¼å®¹
- åœ¨ Step 4 ä¸­ï¼Œå³ä½¿ä½¿ç”¨ç¡¬ç¼–ç  `"general"`ï¼Œä¹Ÿæ˜ç¡®ä¼ é€’å‚æ•°ï¼ˆæ¸…æ™°çš„ä»£ç æ„å›¾ï¼‰

### 4. Mock æµ‹è¯•é™·é˜±

**é£é™©**: æµ‹è¯•ä¸­ mock äº†é”™è¯¯çš„æ¨¡å—è·¯å¾„ï¼Œå¯¼è‡´æµ‹è¯•é€šè¿‡ä½†å®é™…ä»£ç æœ‰é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨æ­£ç¡®çš„ mock è·¯å¾„: `"dashscope.audio.asr.Transcription.async_call"`ï¼ˆä¸ `asr_service.py` ä¸­çš„å¯¼å…¥è·¯å¾„ä¸€è‡´ï¼‰
- åœ¨æ–­è¨€æ—¶ï¼Œæ£€æŸ¥ `call_args.kwargs`ï¼ˆå…³é”®å­—å‚æ•°ï¼‰è€Œä¸æ˜¯ä½ç½®å‚æ•°

### 5. çƒ­è¯IDæ ¼å¼éªŒè¯

**é£é™©**: æ‰‹åŠ¨è¾“å…¥çš„ `ALIYUN_TECH_HOTWORD_ID` å¯èƒ½åŒ…å«ç©ºæ ¼æˆ–æ¢è¡Œç¬¦

**è§£å†³æ–¹æ¡ˆ**:
- åœ¨ä»£ç ä¸­æ·»åŠ ç®€å•çš„éªŒè¯å’Œæ¸…ç†:
  ```python
  hotword_id = os.getenv("ALIYUN_TECH_HOTWORD_ID", "").strip()
  if not hotword_id:
      raise ValueError("...")
  ```

---

## ğŸ“Š æ€§èƒ½ä¸æˆæœ¬è€ƒé‡ (Performance & Cost Considerations)

### API è°ƒç”¨æˆæœ¬

**èƒŒæ™¯**: é˜¿é‡Œäº‘é€šä¹‰å¬æ‚ŸæŒ‰è°ƒç”¨æ¬¡æ•°å’Œæ—¶é•¿è®¡è´¹ï¼Œè‡ªå®šä¹‰çƒ­è¯åŠŸèƒ½å¯èƒ½æœ‰é¢å¤–è´¹ç”¨

**å»ºè®®**:
- åœ¨å¼€å‘å’Œæµ‹è¯•é˜¶æ®µï¼Œä½¿ç”¨è¾ƒçŸ­çš„æµ‹è¯•è§†é¢‘ï¼ˆ< 1åˆ†é’Ÿï¼‰
- ç¡®è®¤é˜¿é‡Œäº‘è´¦æˆ·ä½™é¢å……è¶³ï¼Œé¿å… API è°ƒç”¨å¤±è´¥
- è®°å½•æ¯æ¬¡æµ‹è¯•çš„æˆæœ¬ï¼Œç”¨äºåç»­ä¼˜åŒ–å†³ç­–

### æ€§èƒ½å½±å“

**é¢„æœŸ**: çƒ­è¯æ³¨å…¥å¯¹è½¬å½•é€Ÿåº¦çš„å½±å“å¾®ä¹å…¶å¾®ï¼ˆ< 5% å»¶è¿Ÿï¼‰

**ç›‘æ§æ–¹æ¡ˆ**:
- ä½¿ç”¨ç°æœ‰çš„ `PerformanceLogger` è®°å½• `asr_transcription` æ­¥éª¤çš„è€—æ—¶
- å¯¹æ¯” `tech` æ¨¡å¼ vs `general` æ¨¡å¼çš„å¹³å‡å“åº”æ—¶é—´

---

## ğŸ“ å­¦ä¹ èµ„æº (Learning Resources)

- **é˜¿é‡Œäº‘ DashScope SDK**: https://help.aliyun.com/document_detail/????.html
- **Python Type Hinting**: https://docs.python.org/3/library/typing.html
- **pytest-asyncio**: https://pytest-asyncio.readthedocs.io/en/latest/
- **TDD æœ€ä½³å®è·µ**: https://testdriven.io/blog/modern-tdd/

---

**æœ€åæé†’**: ä¸¥æ ¼æŒ‰ç…§ "æµ‹è¯•å…ˆè¡Œ â†’ å®ç°åŠŸèƒ½ â†’ éªŒè¯é€šè¿‡" çš„ TDD æµç¨‹æ‰§è¡Œï¼Œç¡®ä¿ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§ã€‚å¦‚é‡åˆ°é˜»å¡é—®é¢˜ï¼Œä¼˜å…ˆæŸ¥é˜… `@.cursor/rules` ä¸­çš„ç›¸å…³è§„èŒƒæ–‡æ¡£ã€‚

