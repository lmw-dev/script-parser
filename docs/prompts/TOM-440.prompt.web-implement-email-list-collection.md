# TOM-440.prompt.web-implement-email-list-collection.md

## 🎯 目标定义 (Objective)
* **Linear Issue**: TOM-440 - Web: 实现"未来付费意愿"邮件列表收集
* **核心指令**: 创建一个新的 React 组件 `EmailSubscriptionForm`，用于收集用户邮箱地址。该组件将**直接嵌入并渲染从 Brevo 获取的 HTML 表单代码**。在指定位置（如结果页、页脚）集成此组件，并确保其样式符合项目规范，同时添加必要的加载/成功/错误状态反馈和事件追踪点。

## 📋 上下文引用 (Context References)
* **主要操作文件**:
    * (需要创建) `@components/feature/EmailSubscriptionForm.tsx`
    * (需要创建) `@components/feature/EmailSubscriptionForm.test.tsx`
    * `@app/result/page.tsx` (集成位置之一)
    * `@components/layout/Footer.tsx` (集成位置之一)
* **设计/规范**:
    * **Linear Issue TOM-440 (作为 PRD)**
    * `@rules/001-gen-constitution-principles.mdc`
    * `@rules/010-gen-coding-standards.mdc`
    * `@rules/040-spec-visual-design-principles.mdc`
* **资源**:
    *  嵌入式表单 HTML 代码片段  https://4a87a233.sibforms.com/serve/MUIFAHkjxX-n9rrJ1j42WzYsEjUDdzVZ7rWbrmUKoKdpuTyA0NCSnQH213Ie7BQnp8s6K2R_mGOyzeSqdDeVvbqpZUnf6jwYau3gEsll3Ff793evyFySI2Tke5NultC_BWRg_4xKBOddAryu_udcDlfMXXLy02-doA0pzlrOtwgPwrh33_hXm1HQqCsjdlPKjq0FLFQu-PWj8tCy

## 🔧 实现要求/约束 (Requirements & Constraints)
* **技术栈**: Next.js (App Router), React, TypeScript, Tailwind CSS, shadcn/ui.
* **功能要求**:
    1.  **创建 `EmailSubscriptionForm` 组件**:
        * 该组件应能接收 Brevo 的 HTML 表单代码片段作为 prop 或直接硬编码（如果代码是固定的）。
        * 使用 `dangerouslySetInnerHTML` (或寻找更安全的 React 方式，如果可能) 来渲染 Brevo 提供的 HTML 表单。**注意安全风险，确保 Brevo 代码可信。**
        * 组件应包含一个标题/引导语（例如：“获取未来更新通知”）。
        * **样式覆盖**: 可能需要添加一些 Tailwind CSS 类来调整嵌入表单的样式（输入框、按钮），使其尽量符合 `040-spec-visual-design-principles.mdc` 和 shadcn/ui 的风格。这可能需要检查 Brevo 表单 HTML 的结构并进行针对性样式设置。
        * **状态处理 (基础)**: 虽然表单提交由 Brevo 处理，但我们仍需添加一些**客户端**状态来改善体验：
            * 在用户点击提交按钮后，短暂显示一个加载状态（例如，禁用按钮并显示 Spinner）。
            * Brevo 表单提交后通常会跳转到一个感谢页面或显示内联消息。我们需要观察其默认行为，并可能需要用 JavaScript 监听表单提交事件来触发**客户端**的成功 Toast 通知 (`useToast`)，提示用户“订阅成功！”。
            * 同样地，如果 Brevo 的嵌入表单有内置的错误处理机制（例如，显示错误消息），我们需要确保这些消息样式协调；如果没有，则考虑是否需要添加客户端邮箱格式验证并在提交前显示错误。
    2.  **集成组件**: 在 `/result` 页面和 `Footer` 组件的合适位置嵌入 `EmailSubscriptionForm` 组件。
    3.  **预留追踪点**: 为表单容器、输入框或提交按钮添加 `data-testid` 或 `id`，并考虑绑定 `onSubmit` (如果可行且不干扰 Brevo 自身逻辑) 或 `onClick` 事件处理器，以便后续追踪 `email_subscribe_attempt`, `email_subscribe_success` 等事件。
* **约束**:
    * **优先使用 Brevo 的 HTML 嵌入表单**，避免直接调用 Brevo API（除非嵌入表单方式完全不可行）。
    * **禁止**引入新的外部 UI 或表单库。

## 🧪 测试策略 (Test-First)
* **主要测试类型**: **组件测试 (Component Test)**。
* **测试策略**:
    * **创建测试文件**: `@components/feature/EmailSubscriptionForm.test.tsx`。
    * **编写失败的测试**:
        * 测试 1: 验证组件在接收到模拟的 Brevo HTML 代码时，能够正确渲染出 `<form>`, `<input type="email">` 和提交按钮。
        * 测试 2: 验证组件能正确显示引导语。
        * 测试 3: （如果实现了客户端状态）验证点击提交按钮后，按钮状态变为加载中。
        * 测试 4: （如果实现了客户端状态）验证模拟表单成功提交（可能需要 mock 表单事件）后，会调用 `toast` 显示成功信息。
        * 测试 5: （如果实现了客户端验证）验证输入无效邮箱时，点击提交会显示错误状态（不实际提交）。
    * **运行测试**: 确认测试因组件尚未实现而失败。

## 🔄 实现步骤/要求 (Implementation Steps)
1.  **(需先完成)** 在 Brevo 后台创建邮件列表，并获取**嵌入式表单的 HTML 代码**。
2.  **创建组件文件**: 创建 `EmailSubscriptionForm.tsx` 和 `EmailSubscriptionForm.test.tsx`。
3.  **编写测试**: 按照“测试策略”编写失败的测试用例。
4.  **实现组件**:
    * 编写 `EmailSubscriptionForm` 组件，使用 `dangerouslySetInnerHTML` 或其他方式渲染 Brevo HTML 代码。
    * 添加引导语和基础样式。
    * (可选/推荐) 添加客户端的加载/成功/错误状态处理逻辑和 Toast 通知。
    * 确保所有测试通过。
5.  **集成组件**: 在 `/result` 页面和 `Footer` 组件中引入并使用 `EmailSubscriptionForm` 组件。
6.  **样式微调**: 根据实际效果，使用 Tailwind CSS 微调嵌入表单的样式，使其融入整体设计。
7.  **添加追踪点**: 确保必要的 `data-testid` 或 `id` 已添加。

## ✅ 完成检查清单 (Completion Checklist)
* [ ] Brevo 嵌入式表单 HTML 代码已获取。
* [ ] `EmailSubscriptionForm` 组件及其测试文件已创建。
* [ ] 组件能够成功渲染 Brevo 表单及引导语。
* [ ] (推荐) 组件包含基础的客户端状态处理（加载/成功 Toast）。
* [ ] 组件测试已全部通过 (`pnpm test`)。
* [ ] 组件已在至少一个指定位置成功集成并显示。
* [ ] 嵌入表单的样式已进行调整，与整体风格协调。
* [ ] 已为追踪事件预留了明确的 DOM 属性或事件处理器。
* [ ] Lint 和类型检查通过 (`pnpm run lint`, `tsc --noEmit`)。
* [ ] 代码已提交，Commit Message 符合规范 (e.g., `feat(web): implement email subscription form using Brevo embed`)。