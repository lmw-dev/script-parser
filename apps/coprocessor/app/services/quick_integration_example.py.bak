"""
å¿«é€Ÿé›†æˆæµ‹è¯• - OSSä¸Šä¼ å™¨ä¸ASRæœåŠ¡
ä½¿ç”¨å•ä¸ªæµ‹è¯•æ–‡ä»¶è¿›è¡Œå¿«é€ŸéªŒè¯
"""

import asyncio
import sys
from pathlib import Path

from dotenv import load_dotenv
from services.asr_service import ASRService
from services.oss_uploader import create_oss_uploader_from_env

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
sys.path.insert(0, str(Path(__file__).parent.parent))

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()


async def quick_test():
    """å¿«é€Ÿé›†æˆæµ‹è¯•"""
    print("ğŸš€ å¿«é€Ÿé›†æˆæµ‹è¯• - OSSä¸Šä¼ å™¨ä¸ASRæœåŠ¡")
    print("=" * 50)

    # ä½¿ç”¨è¾ƒå°çš„æµ‹è¯•æ–‡ä»¶
    test_file = Path(
        "/Users/liumingwei/01-project/12-liumw/15-script-parser/docs/data/IMG_0036.MOV"
    )

    if not test_file.exists():
        print(f"âŒ æµ‹è¯•æ–‡ä»¶ä¸å­˜åœ¨: {test_file}")
        return

    try:
        # 1. åˆ›å»ºæœåŠ¡
        print("ğŸ”§ åˆå§‹åŒ–æœåŠ¡...")
        oss_uploader = create_oss_uploader_from_env()
        asr_service = ASRService()

        # 2. ä¸Šä¼ æ–‡ä»¶
        print("â¬†ï¸  ä¸Šä¼ æ–‡ä»¶åˆ°OSS...")
        upload_result = oss_uploader.upload_file(test_file)
        print(f"âœ… ä¸Šä¼ æˆåŠŸ: {upload_result.file_url}")

        # 3. ASRè½¬å½•
        print("ğŸ¤ å¼€å§‹ASRè½¬å½•...")
        try:
            transcript = await asr_service.transcribe_from_url(upload_result.file_url)
            print(f"âœ… è½¬å½•æˆåŠŸ: {transcript}")
            print("\nğŸ‰ å¿«é€Ÿé›†æˆæµ‹è¯•å®Œå…¨é€šè¿‡ï¼")
        except Exception as asr_error:
            print(f"âš ï¸  ASRè½¬å½•è¶…æ—¶æˆ–å¤±è´¥: {str(asr_error)}")
            print("âœ… OSSä¸Šä¼ åŠŸèƒ½æ­£å¸¸å·¥ä½œ")
            print("\nğŸ‰ OSSé›†æˆæµ‹è¯•é€šè¿‡ï¼(ASRå¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´)")

    except Exception as e:
        print(f"âŒ æµ‹è¯•å¤±è´¥: {str(e)}")


if __name__ == "__main__":
    asyncio.run(quick_test())
