"""
OSS Uploader ä¸ ASR Service é›†æˆæµ‹è¯•
ä½¿ç”¨ docs/data ç›®å½•ä¸‹çš„çœŸå®è§†é¢‘æ–‡ä»¶è¿›è¡Œç«¯åˆ°ç«¯æµ‹è¯•
"""

import asyncio
import os
import sys
from pathlib import Path

from dotenv import load_dotenv
from services.asr_service import ASRError, ASRService
from services.oss_uploader import OSSUploaderError, create_oss_uploader_from_env

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
sys.path.insert(0, str(Path(__file__).parent.parent))

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()


class IntegrationTestError(Exception):
    """é›†æˆæµ‹è¯•å¼‚å¸¸"""

    pass


async def test_video_transcription_via_oss(video_file_path: Path) -> dict:
    """
    æµ‹è¯•è§†é¢‘æ–‡ä»¶é€šè¿‡OSSä¸Šä¼ åè¿›è¡ŒASRè½¬å½•çš„å®Œæ•´æµç¨‹

    Args:
        video_file_path: è§†é¢‘æ–‡ä»¶è·¯å¾„

    Returns:
        åŒ…å«æµ‹è¯•ç»“æœçš„å­—å…¸

    Raises:
        IntegrationTestError: å½“æµ‹è¯•å¤±è´¥æ—¶
    """
    test_result = {
        "file_path": str(video_file_path),
        "file_size_mb": 0,
        "upload_success": False,
        "upload_url": None,
        "transcription_success": False,
        "transcript": None,
        "error": None,
        "steps_completed": [],
    }

    try:
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if not video_file_path.exists():
            raise IntegrationTestError(f"æµ‹è¯•æ–‡ä»¶ä¸å­˜åœ¨: {video_file_path}")

        # è·å–æ–‡ä»¶å¤§å°
        file_size = video_file_path.stat().st_size
        test_result["file_size_mb"] = round(file_size / (1024 * 1024), 2)
        print(f"ğŸ“ æµ‹è¯•æ–‡ä»¶: {video_file_path.name} ({test_result['file_size_mb']} MB)")
        test_result["steps_completed"].append("file_check")

        # 1. åˆ›å»ºOSSä¸Šä¼ å™¨
        print("ğŸ”§ åˆ›å»ºOSSä¸Šä¼ å™¨...")
        try:
            oss_uploader = create_oss_uploader_from_env()
            test_result["steps_completed"].append("oss_uploader_created")
        except Exception as e:
            raise IntegrationTestError(f"åˆ›å»ºOSSä¸Šä¼ å™¨å¤±è´¥: {str(e)}") from e

        # 2. ç¡®ä¿bucketå­˜åœ¨
        print("ğŸª£ æ£€æŸ¥å¹¶ç¡®ä¿bucketå­˜åœ¨...")
        try:
            oss_uploader.ensure_bucket_exists()
            test_result["steps_completed"].append("bucket_ensured")
        except OSSUploaderError as e:
            raise IntegrationTestError(f"Bucketæ“ä½œå¤±è´¥: {str(e)}") from e

        # 3. ä¸Šä¼ æ–‡ä»¶åˆ°OSS
        print("â¬†ï¸  ä¸Šä¼ æ–‡ä»¶åˆ°OSS...")
        try:
            upload_result = oss_uploader.upload_file(video_file_path)
            test_result["upload_success"] = True
            test_result["upload_url"] = upload_result.file_url
            test_result["steps_completed"].append("file_uploaded")
            print(f"âœ… æ–‡ä»¶å·²ä¸Šä¼ åˆ°OSS: {upload_result.file_url}")
        except OSSUploaderError as e:
            raise IntegrationTestError(f"æ–‡ä»¶ä¸Šä¼ å¤±è´¥: {str(e)}") from e

        # 4. åˆ›å»ºASRæœåŠ¡
        print("ğŸ¤ åˆ›å»ºASRæœåŠ¡...")
        try:
            asr_service = ASRService()
            test_result["steps_completed"].append("asr_service_created")
        except Exception as e:
            raise IntegrationTestError(f"åˆ›å»ºASRæœåŠ¡å¤±è´¥: {str(e)}") from e

        # 5. ä½¿ç”¨OSS URLè¿›è¡Œè½¬å½•
        print("ğŸ”„ å¼€å§‹ASRè½¬å½•...")
        try:
            transcript = await asr_service.transcribe_from_url(upload_result.file_url)
            test_result["transcription_success"] = True
            test_result["transcript"] = transcript
            test_result["steps_completed"].append("transcription_completed")
            print(
                f"âœ… è½¬å½•å®Œæˆ: {transcript[:100]}..."
                if len(transcript) > 100
                else f"âœ… è½¬å½•å®Œæˆ: {transcript}"
            )
        except ASRError as e:
            # ASRé”™è¯¯ä¸ç®—è‡´å‘½é”™è¯¯ï¼Œè®°å½•ä½†ç»§ç»­
            test_result["error"] = f"ASRè½¬å½•å¤±è´¥: {str(e)}"
            print(f"âš ï¸  ASRè½¬å½•å¤±è´¥: {str(e)}")

        return test_result

    except IntegrationTestError as e:
        test_result["error"] = str(e)
        print(f"âŒ é›†æˆæµ‹è¯•å¤±è´¥: {str(e)}")
        return test_result
    except Exception as e:
        test_result["error"] = f"æœªé¢„æœŸçš„é”™è¯¯: {str(e)}"
        print(f"ğŸ’¥ æœªé¢„æœŸçš„é”™è¯¯: {str(e)}")
        return test_result


async def run_integration_tests():
    """è¿è¡Œé›†æˆæµ‹è¯•"""
    print("ğŸš€ å¼€å§‹OSSä¸Šä¼ å™¨ä¸ASRæœåŠ¡é›†æˆæµ‹è¯•")
    print("=" * 60)

    # æµ‹è¯•æ•°æ®ç›®å½•
    data_dir = Path("../../docs/data")

    # å¦‚æœä»coprocessorç›®å½•è¿è¡Œï¼Œè°ƒæ•´è·¯å¾„
    if not data_dir.exists():
        data_dir = Path("../../../docs/data")

    # å†æ¬¡æ£€æŸ¥è·¯å¾„
    if not data_dir.exists():
        data_dir = Path(
            "/Users/liumingwei/01-project/12-liumw/15-script-parser/docs/data"
        )

    if not data_dir.exists():
        print(f"âŒ æµ‹è¯•æ•°æ®ç›®å½•ä¸å­˜åœ¨: {data_dir}")
        print("è¯·ç¡®ä¿ docs/data ç›®å½•å­˜åœ¨å¹¶åŒ…å«æµ‹è¯•è§†é¢‘æ–‡ä»¶")
        return

    # æŸ¥æ‰¾è§†é¢‘æ–‡ä»¶
    video_extensions = [".mov", ".mp4", ".avi", ".mkv", ".MOV", ".MP4"]
    video_files = []

    for ext in video_extensions:
        video_files.extend(data_dir.glob(f"*{ext}"))

    if not video_files:
        print(f"âŒ åœ¨ {data_dir} ç›®å½•ä¸‹æœªæ‰¾åˆ°è§†é¢‘æ–‡ä»¶")
        print(f"æ”¯æŒçš„æ ¼å¼: {', '.join(video_extensions)}")
        return

    print(f"ğŸ“‚ æ‰¾åˆ° {len(video_files)} ä¸ªè§†é¢‘æ–‡ä»¶:")
    for video_file in video_files:
        file_size = video_file.stat().st_size / (1024 * 1024)
        print(f"  - {video_file.name} ({file_size:.1f} MB)")

    # æµ‹è¯•ç»“æœ
    test_results = []

    # å¯¹æ¯ä¸ªè§†é¢‘æ–‡ä»¶è¿›è¡Œæµ‹è¯•
    for i, video_file in enumerate(video_files, 1):
        print(f"\nğŸ¬ æµ‹è¯• {i}/{len(video_files)}: {video_file.name}")
        print("-" * 40)

        result = await test_video_transcription_via_oss(video_file)
        test_results.append(result)

        # ç®€çŸ­ä¼‘æ¯ï¼Œé¿å…APIé™åˆ¶
        if i < len(video_files):
            print("â³ ç­‰å¾… 3 ç§’...")
            await asyncio.sleep(3)

    # è¾“å‡ºæµ‹è¯•æ€»ç»“
    print("\n" + "=" * 60)
    print("ğŸ“Š é›†æˆæµ‹è¯•æ€»ç»“")
    print("=" * 60)

    successful_uploads = sum(1 for r in test_results if r["upload_success"])
    successful_transcriptions = sum(
        1 for r in test_results if r["transcription_success"]
    )

    print(f"ğŸ“ æµ‹è¯•æ–‡ä»¶æ•°é‡: {len(test_results)}")
    print(f"â¬†ï¸  æˆåŠŸä¸Šä¼ : {successful_uploads}/{len(test_results)}")
    print(f"ğŸ¤ æˆåŠŸè½¬å½•: {successful_transcriptions}/{len(test_results)}")

    # è¯¦ç»†ç»“æœ
    for i, result in enumerate(test_results, 1):
        print(f"\nğŸ“‹ æµ‹è¯• {i}: {Path(result['file_path']).name}")
        print(f"   æ–‡ä»¶å¤§å°: {result['file_size_mb']} MB")
        print(f"   ä¸Šä¼ çŠ¶æ€: {'âœ… æˆåŠŸ' if result['upload_success'] else 'âŒ å¤±è´¥'}")
        if result["upload_url"]:
            print(f"   OSS URL: {result['upload_url']}")
        print(
            f"   è½¬å½•çŠ¶æ€: {'âœ… æˆåŠŸ' if result['transcription_success'] else 'âŒ å¤±è´¥'}"
        )
        if result["transcript"]:
            preview = (
                result["transcript"][:80] + "..."
                if len(result["transcript"]) > 80
                else result["transcript"]
            )
            print(f"   è½¬å½•é¢„è§ˆ: {preview}")
        if result["error"]:
            print(f"   é”™è¯¯ä¿¡æ¯: {result['error']}")
        print(f"   å®Œæˆæ­¥éª¤: {', '.join(result['steps_completed'])}")

    # ç¯å¢ƒæ£€æŸ¥
    print("\nğŸ”§ ç¯å¢ƒé…ç½®æ£€æŸ¥:")
    env_vars = [
        "ALIBABA_CLOUD_ACCESS_KEY_ID",
        "ALIBABA_CLOUD_ACCESS_KEY_SECRET",
        "DASHSCOPE_API_KEY",
        "OSS_ENDPOINT",
        "OSS_BUCKET_NAME",
    ]

    for var in env_vars:
        value = os.getenv(var)
        if value:
            # åªæ˜¾ç¤ºå‰4ä½å’Œå4ä½ï¼Œä¸­é—´ç”¨*ä»£æ›¿
            masked_value = (
                value[:4] + "*" * (len(value) - 8) + value[-4:]
                if len(value) > 8
                else "*" * len(value)
            )
            print(f"   {var}: {masked_value}")
        else:
            print(f"   {var}: âŒ æœªè®¾ç½®")


def main():
    """ä¸»å‡½æ•°"""
    try:
        asyncio.run(run_integration_tests())
    except KeyboardInterrupt:
        print("\nâ¹ï¸  æµ‹è¯•è¢«ç”¨æˆ·ä¸­æ–­")
    except Exception as e:
        print(f"\nğŸ’¥ æµ‹è¯•è¿è¡Œå¤±è´¥: {str(e)}")
        sys.exit(1)


if __name__ == "__main__":
    main()
