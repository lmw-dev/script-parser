# TOM-490: ASR 服务配置指南

## 📋 V3.0 更新：双后端 ASR 服务

现在支持两种 ASR 后端，通过 `ASR_BACKEND` 环境变量切换：

| 后端 | 环境变量值 | 特点 | 热词支持 |
|-----|-----------|------|---------|
| **DashScope** | `dashscope` (默认) | 快速、简单 | ❌ 不支持 |
| **智能语音交互** | `nls` | 完整功能 | ✅ 支持 |

---

## 🚀 快速配置

### 方式 1：使用 DashScope（默认，无热词）

```bash
# .env 文件
ASR_BACKEND=dashscope
DASHSCOPE_API_KEY=sk-xxxxxxxxxxxxxxxx
```

### 方式 2：使用智能语音交互（支持热词）✨ 推荐

```bash
# .env 文件
ASR_BACKEND=nls

# 智能语音交互凭证
ALIYUN_ACCESS_KEY_ID=LTAI5xxxxxxxxx
ALIYUN_ACCESS_KEY_SECRET=xxxxxxxxxxxxxxxx
ALIYUN_NLS_APPKEY=xxxxxxxxxxxxxxxx

# 科技热词表 ID（在智能语音交互控制台创建）
ALIYUN_TECH_HOTWORD_ID=0fd60c7378794843b8fb6c47565101fe
```

---

## 📝 完整配置步骤（智能语音交互 + 热词）

### 步骤 1: 获取阿里云凭证

1. 登录 [阿里云 RAM 控制台](https://ram.console.aliyun.com/)
2. 创建或使用现有的 AccessKey
3. 记录 `AccessKey ID` 和 `AccessKey Secret`

### 步骤 2: 开通智能语音交互服务

1. 访问 [智能语音交互控制台](https://nls-portal.console.aliyun.com/)
2. 开通服务（如果尚未开通）
3. 创建项目，获取 `AppKey`

### 步骤 3: 创建热词表

1. 在智能语音交互控制台，导航到 `自学习平台` → `热词`
2. 点击 `创建热词表`
3. 选择 **业务专用** 类型
4. 上传热词文件：`app/assets/tech_hotwords_final.txt`
5. 保存并复制热词表 ID

### 步骤 4: 配置环境变量

   ```bash
# .env 文件
ASR_BACKEND=nls
ALIYUN_ACCESS_KEY_ID=你的AccessKey_ID
ALIYUN_ACCESS_KEY_SECRET=你的AccessKey_Secret
ALIYUN_NLS_APPKEY=你的AppKey
ALIYUN_TECH_HOTWORD_ID=你的热词表ID
```

### 步骤 5: 重启服务

```bash
# 重启后端服务
pkill -f uvicorn && uvicorn app.main:app --reload --port 8000
```

---

## 🔍 验证配置

### 查看启动日志

```
🔧 [ASR Factory] 创建 ASR 服务: backend=nls
✅ [ASR Factory] 已创建 NLS ASR 服务（支持热词）
```

### 测试热词功能

使用科技类型分析一个科技视频，检查日志：

```
🔧 [NLS-ASR] 科技模式: 使用热词表 0fd60c7378794843b8fb6c47565101fe
🔧 [NLS-ASR] 热词表已注入: vocabulary_id=0fd60c7378794843b8fb6c47565101fe
```

---

## ⚠️ 常见问题

### Q1: 为什么 DashScope 不支持热词？

**A**: DashScope 的 `phrase_id` 参数需要在 DashScope 控制台创建短语表，而不是智能语音交互的热词表。两者是不同的系统。

### Q2: 切换后端需要改代码吗？

**A**: 不需要，只需修改 `.env` 文件中的 `ASR_BACKEND` 变量即可。

### Q3: 智能语音交互的费用如何？

**A**: 智能语音交互的录音文件识别按音频时长计费，具体价格请参考[阿里云定价页](https://www.aliyun.com/price/product#/nls/detail/nls)。

### Q4: 两个后端的识别效果有差异吗？

**A**: 基础识别效果相近。智能语音交互在科技类内容上，配合热词表可以显著提升专业术语的识别准确率。

---

## 📚 参考文档

- [智能语音交互 SDK 概览](https://help.aliyun.com/zh/isi/getting-started/sdk-and-api-references)
- [录音文件识别接口说明](https://help.aliyun.com/zh/isi/developer-reference/api-reference-2)
- [Python SDK 录音文件识别](https://help.aliyun.com/zh/isi/developer-reference/sdk-for-python-3)

---

**最后更新**: 2025-12-09  
**任务**: TOM-490 - 双后端 ASR 服务（支持热词功能）
