# 端到端工作流和资源清理需求文档

## 介绍

本文档定义了 `/api/parse` 端点的端到端工作流编排和资源清理机制的需求。该端点需要整合所有服务模块，实现完整的视频分析工作流，并提供标准化的错误处理和资源管理。

## 需求

### 需求1：端到端工作流编排

**用户故事：** 作为API用户，我希望通过单一端点完成完整的视频分析工作流，包括视频源获取、ASR转录和LLM分析。

#### 验收标准

1. WHEN 用户提供视频URL时 THEN 系统应该依次执行URL解析、ASR转录、LLM分析的完整流程
2. WHEN 用户上传视频文件时 THEN 系统应该依次执行文件保存、OSS上传、ASR转录、LLM分析的完整流程
3. WHEN 任何步骤成功完成时 THEN 系统应该将结果传递给下一个步骤
4. WHEN 整个工作流成功完成时 THEN 系统应该返回包含所有分析结果的完整响应

### 需求2：标准化响应格式

**用户故事：** 作为前端开发者，我希望API返回标准化的响应格式，包含业务状态码和详细的错误信息。

#### 验收标准

1. WHEN 请求成功处理时 THEN 响应应该包含HTTP状态码200和业务码0
2. WHEN 发生客户端错误时 THEN 响应应该包含4xx HTTP状态码和相应的业务错误码
3. WHEN 发生服务器错误时 THEN 响应应该包含5xx HTTP状态码和相应的业务错误码
4. WHEN 返回错误响应时 THEN 响应体应该包含code、success、message字段

### 需求3：资源清理机制

**用户故事：** 作为系统管理员，我希望系统能够自动清理临时文件，防止磁盘空间泄露。

#### 验收标准

1. WHEN 处理文件上传请求时 THEN 系统应该在请求完成后自动删除临时文件
2. WHEN 处理过程中发生异常时 THEN 系统仍应该确保临时文件被清理
3. WHEN 使用try-finally块时 THEN finally块应该总是执行资源清理操作
4. IF 临时文件不存在 THEN 清理操作应该优雅地处理而不抛出异常

### 需求4：错误处理和映射

**用户故事：** 作为API用户，我希望收到有意义的错误信息，帮助我理解问题并采取相应的行动。

#### 验收标准

1. WHEN URLParserError发生时 THEN 系统应该返回HTTP 400状态码和业务码4001
2. WHEN ASRError发生时 THEN 系统应该返回HTTP 503状态码和业务码5001
3. WHEN LLMError发生时 THEN 系统应该返回HTTP 502状态码和业务码5002
4. WHEN 发生未预期异常时 THEN 系统应该返回HTTP 500状态码和业务码9999
5. WHEN 返回错误响应时 THEN 错误信息应该对用户友好且不泄露敏感信息

### 需求5：服务集成和依赖管理

**用户故事：** 作为开发者，我希望系统能够正确集成所有服务模块，并处理服务间的依赖关系。

#### 验收标准

1. WHEN 处理URL请求时 THEN 系统应该使用ShareURLParser解析视频信息
2. WHEN 处理文件上传时 THEN 系统应该使用FileHandler保存文件并使用OSSUploader上传
3. WHEN 进行ASR转录时 THEN 系统应该使用ASRService并正确处理OSS集成
4. WHEN 进行LLM分析时 THEN 系统应该使用LLMRouter实现主备切换
5. WHEN 服务初始化失败时 THEN 系统应该抛出相应的配置错误

### 需求6：请求验证和输入处理

**用户故事：** 作为API用户，我希望系统能够正确验证我的请求格式，并提供清晰的验证错误信息。

#### 验收标准

1. WHEN 请求既没有URL也没有文件时 THEN 系统应该返回HTTP 400错误
2. WHEN JSON格式无效时 THEN 系统应该返回HTTP 422错误
3. WHEN 使用form-data发送URL时 THEN 系统应该返回HTTP 422错误提示应使用JSON
4. WHEN 请求格式正确时 THEN 系统应该根据内容类型选择正确的处理路径

### 需求7：性能和超时处理

**用户故事：** 作为API用户，我希望系统能够在合理的时间内完成处理，并在超时时提供明确的反馈。

#### 验收标准

1. WHEN 处理1分钟视频时 THEN 总处理时间应该不超过50秒
2. WHEN ASR服务超时时 THEN 系统应该返回相应的超时错误
3. WHEN LLM服务超时时 THEN 系统应该尝试故障切换到备用服务
4. WHEN 所有服务都超时时 THEN 系统应该返回服务不可用错误

### 需求8：日志和监控

**用户故事：** 作为运维人员，我希望系统提供详细的日志信息，便于问题排查和性能监控。

#### 验收标准

1. WHEN 处理请求时 THEN 系统应该记录关键步骤的执行时间
2. WHEN 发生错误时 THEN 系统应该记录详细的错误信息和堆栈跟踪
3. WHEN 服务调用失败时 THEN 系统应该记录失败的服务和原因
4. WHEN 资源清理执行时 THEN 系统应该记录清理操作的结果