# 端到端工作流和资源清理实现计划

- [x] 1. 更新响应模型以支持业务状态码
  - 修改VideoParseResponse模型，添加code字段用于业务状态码
  - 添加processing_time字段记录处理时间
  - 确保success字段正确反映操作状态
  - 保持data和message字段的可选性
  - _需求: 2.1, 2.2, 2.3, 2.4_

- [x] 2. 实现标准化错误处理机制
  - 创建错误码映射表，定义各种异常对应的HTTP状态码和业务码
  - 实现URLParserError到HTTP 400 + 业务码4001的映射
  - 实现ASRError到HTTP 503 + 业务码5001的映射
  - 实现LLMError到HTTP 502 + 业务码5002的映射
  - 实现FileHandlerError到HTTP 500 + 业务码5003的映射
  - 实现OSSUploaderError到HTTP 503 + 业务码5004的映射
  - 实现通用Exception到HTTP 500 + 业务码9999的映射
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 3. 重构/api/parse端点的主要处理逻辑
  - 添加请求开始时间记录用于计算processing_time
  - 重构JSON请求处理逻辑，使用统一的工作流编排
  - 重构multipart请求处理逻辑，使用统一的工作流编排
  - 确保所有成功响应返回HTTP 200状态码和业务码0
  - 移除重复的错误处理代码，使用统一的异常处理机制
  - _需求: 1.1, 1.2, 1.3, 1.4, 2.1_

- [-] 4. 实现完整的资源清理机制
  - 在文件处理流程中使用try-finally块确保资源清理
  - 确保temp_file_info变量在异常情况下仍能被正确清理
  - 实现FileHandler.cleanup的安全调用，处理文件不存在的情况
  - 验证finally块在所有异常情况下都能执行
  - _需求: 3.1, 3.2, 3.3, 3.4_

- [ ] 5. 优化服务集成和依赖管理
  - 确保ShareURLParser在URL处理流程中正确初始化和使用
  - 确保FileHandler和OSSUploader在文件处理流程中正确集成
  - 确保ASRService正确处理OSS集成模式和传统模式
  - 确保LLMRouter正确实现主备切换机制
  - 添加服务初始化失败的错误处理
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 6. 完善请求验证和输入处理
  - 改进请求格式验证，确保错误信息清晰明确
  - 优化JSON解析错误处理，返回HTTP 422状态码
  - 优化form-data URL处理，返回明确的格式错误提示
  - 确保所有验证错误都返回适当的HTTP状态码和业务码
  - _需求: 6.1, 6.2, 6.3, 6.4_

- [ ] 7. 编写全面的集成测试
  - 创建test_main.py文件或更新现有测试文件
  - 实现成功的URL工作流测试，验证HTTP 200和业务码0
  - 实现成功的文件上传工作流测试，验证响应格式和资源清理
  - 实现ASR服务失败测试，验证HTTP 503和业务码5001
  - 实现LLM服务失败测试，验证HTTP 502和业务码5002
  - 实现URL解析失败测试，验证HTTP 400和业务码4001
  - 实现文件处理失败测试，验证资源清理机制
  - 使用Mock隔离所有外部服务依赖
  - _需求: 所有需求的测试覆盖_

- [ ] 8. 添加性能监控和日志记录
  - 在关键步骤添加处理时间记录
  - 实现请求ID生成用于日志跟踪
  - 添加详细的错误日志记录，包含堆栈跟踪
  - 记录各个服务调用的耗时和结果
  - 确保敏感信息不出现在日志中
  - _需求: 7.1, 7.2, 7.3, 7.4, 8.1, 8.2, 8.3, 8.4_

- [ ] 9. 实现超时和性能优化
  - 设置合理的服务调用超时时间
  - 优化文件上传和处理的内存使用
  - 实现HTTP连接复用以提高性能
  - 添加处理时间监控，确保满足50秒目标
  - _需求: 7.1, 7.2, 7.3, 7.4_

- [ ] 10. 代码质量检查和文档完善
  - 运行ruff check确保代码符合规范
  - 运行ruff format进行代码格式化
  - 添加完整的类型注解和文档字符串
  - 确保所有测试通过
  - 更新API文档和错误码说明
  - _需求: 代码质量需求_