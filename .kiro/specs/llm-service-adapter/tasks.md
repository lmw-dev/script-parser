# LLM服务适配器模式实现计划

- [x] 1. 创建核心数据模型和异常类
  - 实现AnalysisResult数据模型，包含hook、core、cta字段
  - 创建LLMError异常类用于统一错误处理
  - 添加数据模型的验证逻辑
  - _需求: 1.1, 5.1, 5.2, 5.3, 6.1_

- [x] 2. 定义LLMService协议接口
  - 创建LLMService协议，定义analyze方法签名
  - 确保协议支持异步操作
  - 添加类型注解以提供更好的IDE支持
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [x] 3. 实现外部Prompt文件加载机制
  - 创建app/prompts/structured_analysis.prompt文件
  - 实现从外部文件加载系统提示词的逻辑
  - 添加文件不存在时的错误处理
  - 确保使用UTF-8编码正确读取文件
  - _需求: 2.1, 2.2, 2.3, 2.4_

- [x] 4. 实现DeepSeek适配器
  - 创建DeepSeekAdapter类实现LLMService协议
  - 实现从DEEPSEEK_API_KEY环境变量读取API密钥
  - 实现HTTP API调用逻辑，包含正确的请求头和参数
  - 添加JSON响应解析和AnalysisResult对象创建
  - 实现完整的错误处理，包括HTTP错误、网络错误、解析错误
  - _需求: 1.2, 4.1, 4.3, 5.1, 6.1, 6.2, 6.3, 6.4_

- [x] 5. 实现Kimi适配器
  - 创建KimiAdapter类实现LLMService协议
  - 实现从KIMI_API_KEY环境变量读取API密钥
  - 实现HTTP API调用逻辑，使用正确的模型名称和端点
  - 添加JSON响应解析和AnalysisResult对象创建
  - 实现完整的错误处理机制
  - _需求: 1.3, 4.2, 4.3, 5.1, 6.1, 6.2, 6.3, 6.4_

- [x] 6. 实现LLMRouter主备切换逻辑
  - 创建LLMRouter类，接受主服务和备用服务参数
  - 实现analyze方法，优先使用主服务
  - 添加主服务失败时自动切换到备用服务的逻辑
  - 实现所有服务都失败时的错误处理
  - _需求: 3.1, 3.2, 3.3, 3.4_

- [x] 7. 实现工厂函数
  - 创建create_llm_router_from_env函数
  - 实现从环境变量自动创建适配器实例
  - 配置DeepSeek作为主服务，Kimi作为备用服务
  - 添加环境变量缺失时的错误处理
  - _需求: 7.1, 7.2, 7.3, 7.4_

- [x] 8. 编写全面的单元测试
  - 创建test_llm_service.py测试文件
  - 实现协议存在性测试
  - 添加数据模型创建和验证测试
  - 实现适配器初始化、API调用成功、各种错误场景的测试
  - 添加路由器主服务成功、故障切换、全部失败场景的测试
  - 实现工厂函数的各种场景测试
  - 使用Mock隔离外部依赖（httpx、文件系统、环境变量）
  - _需求: 所有需求的测试覆盖_

- [x] 9. 集成到主应用程序
  - 在main.py中导入LLM服务相关模块
  - 在/api/parse端点中集成LLM分析功能
  - 添加LLMError异常的捕获和处理
  - 确保LLM分析结果正确包含在API响应中
  - _需求: 集成需求_

- [x] 10. 代码质量检查和优化
  - 运行ruff check确保代码符合规范
  - 运行ruff format进行代码格式化
  - 修复所有代码质量问题
  - 确保所有测试通过
  - _需求: 代码质量需求_

- [x] 11. 文档和规范完善
  - 创建详细的需求文档
  - 编写设计文档，包含架构图和组件说明
  - 完善代码注释和文档字符串
  - 创建实现计划任务列表
  - _需求: 文档需求_