# ==================================================
# ScriptParser Mac mini 本地部署配置
# ==================================================

services:
  # Nginx 反向代理
  nginx:
    image: nginx:1.27-alpine
    container_name: sp_macmini_nginx
    restart: unless-stopped
    ports:
      - "8081:80"  # 避免 80 端口冲突，使用 8081
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      web:
        condition: service_healthy
      coprocessor:
        condition: service_healthy
    networks:
      - sp_macmini_network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost/nginx-health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Next.js Web应用
  web:
    build:
      context: .
      dockerfile: ./apps/web/Dockerfile
      args:
        # Mac mini 局域网访问 - 使用 Mac mini 的实际 IP
        NEXT_PUBLIC_API_URL: http://100.123.255.27:8081
    image: scriptparser-web:macmini
    container_name: sp_macmini_web
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://100.123.255.27:8081
    expose:
      - "3000"
    networks:
      - sp_macmini_network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # FastAPI AI协处理器
  coprocessor:
    build:
      context: ./apps/coprocessor
      dockerfile: Dockerfile
    image: scriptparser-coprocessor:macmini
    container_name: sp_macmini_coprocessor
    restart: unless-stopped
    volumes:
      # 挂载代码目录，支持热更新
      - ./apps/coprocessor/app:/app/app:ro
    environment:
      - HOST=0.0.0.0
      - PORT=8000
      - DEBUG=false
      - NODE_ENV=production
    env_file:
      - ./apps/coprocessor/.env
    expose:
      - "8000"
    networks:
      - sp_macmini_network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  sp_macmini_network:
    driver: bridge
    name: sp_macmini_network

volumes:
  sp_macmini_nginx_data:
    name: sp_macmini_nginx_data
